<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Judging Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", Arial;
      background: #f4f6fa;
      margin: 0;
      color: #333;
    }

    header {
      background: #004aad;
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #fff;
      margin: 0;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
    }

    select,
    input[type=range] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      margin-top: 5px;
    }

    button {
      margin-top: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      background: #005fcc;
    }

    .score-display {
      background: #007bff;
      color: white;
      border-radius: 50%;
      display: inline-block;
      width: 35px;
      height: 35px;
      line-height: 35px;
      text-align: center;
      margin-left: 10px;
    }

    .alert {
      background: #e8f9f0;
      padding: 10px 15px;
      border-left: 4px solid #28a745;
      border-radius: 8px;
      margin-bottom: 10px;
      color: #2d7a46;
    }
  </style>
</head>

<body>
  <header>
    <h2>Judging Dashboard</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <main>
    <label>Select Team:</label>
    <select id="teamSelect">
      <option value="">-- Select a Team --</option>
    </select>

    <div id="criteriaForm" style="margin-top:20px;"></div>
    <button id="saveBtn" onclick="saveScores()">üíæ Save Scores</button>
  </main>

  <script>
    const API = "https://judging-system.yeewengloke.workers.dev";

    const judge_id = localStorage.getItem("judge_id");
    if (!judge_id) window.location.href = "index.html";

    if (!localStorage.getItem("judge_id")) {
      window.location.href = "index.html";
    }

    function isBackForwardNavigation() {
      if (window.performance.getEntriesByType) {
        const navEntries = performance.getEntriesByType("navigation");
        if (navEntries.length > 0) {
          return navEntries[0].type === "back_forward";
        }
      }
      if (window.performance && window.performance.navigation) {
        return window.performance.navigation.type === 2;
      }
      return false;
    }

    if (isBackForwardNavigation()) {
      localStorage.removeItem("isAdmin");
      localStorage.removeItem("judge_id");
      window.location.href = "index.html";
    }

    const teamSelect = document.getElementById("teamSelect");
    const formDiv = document.getElementById("criteriaForm");
    const saveBtn = document.getElementById("saveBtn");

    let criteriaList = [];

    const DEFAULT_CRITERIA = [
      { criteria_code: "creativity", criteria_name: "Creativity" },
      { criteria_code: "practical", criteria_name: "Practicality" },
      { criteria_code: "social", criteria_name: "Social Impact" },
      { criteria_code: "cost", criteria_name: "Cost" },
      { criteria_code: "presentation", criteria_name: "Presentation" }
    ];

    // ===== INIT =====
    async function init() {
      try {
        // Try fetching from server, but fallback if fails/empty
        try {
          const critRes = await fetch(API + "/criteria");
          if (!critRes.ok) throw new Error("Criteria endpoint failed");
          const data = await critRes.json();
          console.log("Fetched criteria raw data:", data); // üîç DEBUG

          if (Array.isArray(data) && data.length > 0) {
            // Normalize keys just in case
            criteriaList = data.map(item => {
              const code = item.criteria_code || item.code || item.id || (item.criteria_name ? item.criteria_name.toLowerCase() : "") || (item.name ? item.name.toLowerCase() : "");
              const name = item.criteria_name || item.name || item.criteria_code || "Unknown Criteria";
              return { criteria_code: code, criteria_name: name };
            });
            console.log("Normalized criteriaList:", criteriaList);
          } else {
            throw new Error("Empty criteria list");
          }
        } catch (e) {
          console.warn("Using default criteria because:", e);
          criteriaList = DEFAULT_CRITERIA;
        }

        // üîç DEBUG: Log the exact URL
        // Fix: Force uppercase for judge_id as DB stores it as J001 (uppercase) while login returns j001 (lowercase)
        const effectiveJudgeId = judge_id.toUpperCase();
        const teamsUrl = `${API}/assigned-teams?judge_id=${effectiveJudgeId}`;
        console.log("Fetching from:", teamsUrl);

        const teamsRes = await fetch(teamsUrl);
        console.log("Status:", teamsRes.status); // Should be 200

        const assignedTeams = await teamsRes.json();
        console.log("Assigned teams:", assignedTeams); // Should be [ { team_code: "FE-001", ... } ]

        if (Array.isArray(assignedTeams)) {
          assignedTeams.forEach(t => {
            const opt = document.createElement("option");
            opt.value = t.team_code;
            opt.textContent = `${t.team_code} - ${t.team_name}`;
            teamSelect.appendChild(opt);
          });
        }

        teamSelect.addEventListener("change", handleTeamChange);
      } catch (err) {
        console.error("Init failed:", err);
        alert("Failed to load your assigned teams. Please log in again.");
        logout();
      }
    }

    // ===== LOAD SCORES =====
    async function handleTeamChange() {
      const team_code = teamSelect.value;
      if (!team_code) { formDiv.innerHTML = ""; return; }
      formDiv.innerHTML = "<p>Loading scores...</p>";

      try {
        const url = `${API}/scores?judge_id=${judge_id}&team_code=${team_code}`;
        const res = await fetch(url);
        const existingScores = await res.json();

        renderScoringForm(existingScores);

        if (Object.keys(existingScores).length > 0) {
          // Already graded ‚Üí disable
          disableFormInputs();
          showAlert("‚ö†Ô∏è You have already graded this team. Scores are locked.", "warning");
        } else {
          showAlert("‚úÖ You can now grade this team.", "success");
        }
      } catch (err) {
        showAlert("‚ö†Ô∏è Could not load scores. Starting new grading.", "warning");
        renderScoringForm({});
      }
    }

    // ===== RENDER FORM =====
    function renderScoringForm(existingScores = {}) {
      formDiv.innerHTML = criteriaList.map(c => `
        <label>
          ${c.criteria_name} (${c.criteria_code})
          <input type="range" id="${c.criteria_code}" min="0" max="10" step="1"
                 value="${existingScores[c.criteria_code] ?? 0}">
          <span class="score-display" id="disp_${c.criteria_code}">
            ${existingScores[c.criteria_code] ?? 0}
          </span>
        </label>
      `).join("");

      criteriaList.forEach(c => {
        const slider = document.getElementById(c.criteria_code);
        const disp = document.getElementById("disp_" + c.criteria_code);
        slider.oninput = () => { disp.textContent = slider.value; };
      });
    }

    // ===== ALERT BOX =====
    function showAlert(message, type = "success") {
      const old = formDiv.querySelector(".alert");
      if (old) old.remove();
      const alertDiv = document.createElement("div");
      alertDiv.className = "alert";
      if (type === "warning") {
        alertDiv.style.borderLeftColor = "#ffc107";
        alertDiv.style.backgroundColor = "#fff8e1";
        alertDiv.style.color = "#856404";
      }
      alertDiv.textContent = message;
      formDiv.prepend(alertDiv);
    }

    // ===== DISABLE FORM =====
    function disableFormInputs() {
      formDiv.querySelectorAll("input[type=range]").forEach(s => s.disabled = true);
      saveBtn.disabled = true;
    }

    // ===== SAVE SCORES =====
    async function saveScores() {
      const team_code = teamSelect.value;
      if (!team_code) return alert("Please select a team first.");

      const scores = {};
      criteriaList.forEach(c => {
        scores[c.criteria_code] = parseFloat(document.getElementById(c.criteria_code)?.value) || 0;
      });

      try {
        const res = await fetch(API + "/scores", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ judge_id, team_code, scores }),
        });

        const data = await res.json();
        if (data.success) {
          alert("‚úÖ Scores saved successfully!");
          disableFormInputs();
          showAlert("‚úÖ Scores saved and locked.", "success");
        } else {
          throw new Error(data.error || "Unknown error");
        }
      } catch (err) {
        alert("‚ùå Save failed: " + err.message);
      }
    }

    // ===== LOGOUT =====
    function logout() {
      localStorage.removeItem("judge_id");
      window.location.href = "index.html";
    }

    // ===== START =====
    init();
  </script>
</body>

</html>