<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Judging Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", Arial;
      background: #f4f6fa;
      margin: 0;
      color: #333;
    }

    header {
      background: #004aad;
      color: white;
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      max-width: 900px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    h2 {
      color: #fff;
      margin: 0;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 500;
    }

    select,
    input[type=range] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      margin-top: 5px;
    }

    button {
      margin-top: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
    }

    button:hover {
      background: #005fcc;
    }

    .score-display {
      background: #007bff;
      color: white;
      border-radius: 50%;
      display: inline-block;
      width: 35px;
      height: 35px;
      line-height: 35px;
      text-align: center;
      margin-left: 10px;
    }

    .alert {
      background: #e8f9f0;
      padding: 10px 15px;
      border-left: 4px solid #28a745;
      border-radius: 8px;
      margin-bottom: 10px;
      color: #2d7a46;
    }
  </style>
</head>

<body>
  <header>
    <h2>Judging Dashboard</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <main>
    <main>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3 style="margin:0;">Evaluation</h3>
        <button id="timerBtn" onclick="toggleTimer()" style="margin-top:0; background:#6c757d;">‚è±Ô∏è Start 10m
          Timer</button>
      </div>

      <label>Select Team (Sequential Order):</label>
      <select id="teamSelect">
        <option value="">-- Loading Assignments --</option>
      </select>

      <div id="criteriaForm" style="margin-top:20px;"></div>
      <button id="saveBtn" onclick="saveScores()">üíæ Save Scores</button>
    </main>

    <script>
      const API = "https://judging-system.yeewengloke.workers.dev";

      // --- AUTH CHECK ---
      const judge_id = localStorage.getItem("judge_id");
      if (!judge_id) window.location.href = "index.html";
      if (isBackForwardNavigation()) {
        localStorage.clear();
        window.location.href = "index.html";
      }
      function isBackForwardNavigation() {
        if (window.performance && window.performance.navigation) return window.performance.navigation.type === 2;
        return false;
      }

      // --- DOM ---
      const teamSelect = document.getElementById("teamSelect");
      const formDiv = document.getElementById("criteriaForm");
      const saveBtn = document.getElementById("saveBtn");
      const timerBtn = document.getElementById("timerBtn");

      let assignedTeamsList = []; // Store globally for re-render
      let myScoresCache = {};     // Store globally to track progress

      // REVISED CRITERIA SETS
      const CRITERIA_IM = [
        { criteria_code: "C001", criteria_name: "Creativity" },
        { criteria_code: "C002", criteria_name: "Practicality" },
        { criteria_code: "C003", criteria_name: "Social Impact" },
        { criteria_code: "C004", criteria_name: "Cost" },
        { criteria_code: "C005", criteria_name: "Sustainability" },
        { criteria_code: "C006", criteria_name: "Presentation" }
      ];

      const CRITERIA_IT = [
        { criteria_code: "T001", criteria_name: "Basic Coding" },
        { criteria_code: "T002", criteria_name: "Code Explanation" },
        { criteria_code: "T003", criteria_name: "System Flow" },
        { criteria_code: "T004", criteria_name: "Script Test" },
        { criteria_code: "T005", criteria_name: "API Usage" }
      ];

      // --- TIMER LOGIC ---
      let timerInterval = null;
      let timeRemaining = 600; // 10 minutes
      let isTimerRunning = false;

      function toggleTimer() {
        if (isTimerRunning) {
          // Stop
          clearInterval(timerInterval);
          isTimerRunning = false;
          timerBtn.textContent = "‚è±Ô∏è Resume 10m Timer";
          timerBtn.style.background = "#ffc107"; // Yellow/Pause
          timerBtn.style.color = "#000";
        } else {
          // Start
          if (timeRemaining <= 0) timeRemaining = 600; // Reset if finished previously
          isTimerRunning = true;
          timerBtn.style.background = "#dc3545"; // Red/Stop
          timerBtn.style.color = "#fff";

          timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 0) {
              clearInterval(timerInterval);
              isTimerRunning = false;
              timerBtn.textContent = "‚è∞ Time is Up!";
              timerBtn.style.background = "#28a745";
              alert("‚è∞ Time is Up! Please wrap up your grading.");
            }
          }, 1000);
          updateTimerDisplay();
        }
      }

      function updateTimerDisplay() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        timerBtn.textContent = `‚è≥ ${m}:${s.toString().padStart(2, '0')} (Stop)`;
      }


      // --- INIT ---
      async function init() {
        try {
          // 1. Load Assigned Teams AND My Scores (Parallel)
          const effectiveJudgeId = judge_id.toUpperCase();

          const [teamsRes, scoresRes] = await Promise.all([
            fetch(`${API}/assigned-teams?judge_id=${effectiveJudgeId}`),
            fetch(`${API}/all-scores`) // Fetching all effectively, then we filter client side
          ]);

          if (!teamsRes.ok) throw new Error("Failed to load assignments");
          const teamsData = await teamsRes.json();
          assignedTeamsList = Array.isArray(teamsData) ? teamsData : (teamsData.results || []);

          let allScores = [];
          if (scoresRes.ok) {
            allScores = await scoresRes.json();
          }

          // Filter scores for THIS judge only
          const myScores = allScores.filter(s => (s.judge_id || "").toUpperCase() === effectiveJudgeId);

          // Build a Set of completed team codes
          const doneTeamCodes = new Set(myScores.map(s => s.team_code));

          // Cache detailed scores for rendering logic later
          myScoresCache = {}; // Map: team_code -> { "C001": 10, ... }
          myScores.forEach(s => {
            if (!myScoresCache[s.team_code]) myScoresCache[s.team_code] = {};
            myScoresCache[s.team_code][s.criteria_code] = s.score;
          });

          renderDropdown(doneTeamCodes);

          teamSelect.addEventListener("change", handleTeamChange);

        } catch (err) {
          console.error("Init failed:", err);
          alert("Failed to initialize. Please refresh.");
        }
      }

      function renderDropdown(doneTeamCodes) {
        teamSelect.innerHTML = "";

        let nextFound = false;
        let firstAvailable = null;

        assignedTeamsList.forEach((t, index) => {
          const isDone = doneTeamCodes.has(t.team_code);
          const opt = document.createElement("option");
          opt.value = t.team_code;

          if (isDone) {
            // Completed Team
            opt.textContent = `‚úÖ ${t.team_code} - ${t.team_name} (Done)`;
          } else {
            // Not Done yet
            if (!nextFound) {
              // This is the NEXT immediate team (The "Active" one)
              opt.textContent = `üëâ ${t.team_code} - ${t.team_name} (Judge Now)`;
              nextFound = true;
              firstAvailable = t.team_code;
            } else {
              // Future team -> LOCKED
              opt.textContent = `üîí ${t.team_code} - ${t.team_name} (Locked)`;
              opt.disabled = true;
            }
          }
          teamSelect.appendChild(opt);
        });

        // Auto-select the first available team if nothing selected
        if (firstAvailable) {
          teamSelect.value = firstAvailable;
          handleTeamChange(); // load it
        } else if (assignedTeamsList.length > 0) {
          // All done? Select the last one maybe
          teamSelect.value = assignedTeamsList[assignedTeamsList.length - 1].team_code;
          handleTeamChange();
          showAlert("üéâ All assigned teams completed!", "success");
        } else {
          teamSelect.innerHTML = "<option>No teams assigned.</option>";
        }
      }

      // ===== LOAD SCORES =====
      function handleTeamChange() {
        const team_code = teamSelect.value;

        // RESET TIMER whenever we switch teams
        if (isTimerRunning) {
          clearInterval(timerInterval);
          isTimerRunning = false;
        }
        timeRemaining = 600; // Reset to 10m
        updateTimerDisplay();
        timerBtn.textContent = "‚è±Ô∏è Start 10m Timer";
        timerBtn.style.background = "#6c757d";
        timerBtn.style.color = "white";

        if (!team_code) { formDiv.innerHTML = ""; return; }

        formDiv.innerHTML = "<p>Loading...</p>";

        // Determine Category
        // We look up the team object in assignedTeamsList
        const teamObj = assignedTeamsList.find(t => t.team_code === team_code);
        let activeCriteria = CRITERIA_IM; // fallback
        if (teamObj) {
          const cat = (teamObj.category || "").toLowerCase();
          if (cat.includes("inno-tech") || cat.includes("tech-hackathon")) {
            activeCriteria = CRITERIA_IT;
          } else {
            activeCriteria = CRITERIA_IM;
          }
        }

        // Use cached scores instead of fetching again
        const existingScores = myScoresCache[team_code] || {};
        const isDone = Object.keys(existingScores).length > 0;

        renderScoringForm(activeCriteria, existingScores);

        if (isDone) {
          // Locked
          disableFormInputs();
          showAlert("‚úÖ Scores submitted. (Read-only)", "success");
        } else {
          // Active
          enableFormInputs();
          showAlert("üìù Please enter scores.", "success");
        }
      }

      function renderScoringForm(criteriaList, existingScores = {}) {
        formDiv.innerHTML = criteriaList.map(c => `
        <label>
          ${c.criteria_name} (${c.criteria_code})
          <input type="range" id="${c.criteria_code}" min="0" max="10" step="1"
                 value="${existingScores[c.criteria_code] ?? 0}">
          <span class="score-display" id="disp_${c.criteria_code}">
            ${existingScores[c.criteria_code] ?? 0}
          </span>
        </label>
      `).join("");

        criteriaList.forEach(c => {
          const slider = document.getElementById(c.criteria_code);
          const disp = document.getElementById("disp_" + c.criteria_code);
          if (slider && disp) {
            slider.oninput = () => { disp.textContent = slider.value; };
          }
        });

        // Save logic needs to know WHICH criteria to read. 
        // We can attach the current list to the DOM or a global var.
        window.currentCriteriaList = criteriaList;
      }

      function showAlert(message, type = "success") {
        const old = formDiv.querySelector(".alert");
        if (old) old.remove();
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert";
        if (type === "warning") {
          alertDiv.style.borderLeftColor = "#ffc107";
          alertDiv.style.backgroundColor = "#fff8e1";
          alertDiv.style.color = "#856404";
        }
        alertDiv.textContent = message;
        formDiv.prepend(alertDiv);
      }

      function disableFormInputs() {
        formDiv.querySelectorAll("input[type=range]").forEach(s => s.disabled = true);
        saveBtn.disabled = true;
        saveBtn.style.opacity = "0.5";
      }

      function enableFormInputs() {
        formDiv.querySelectorAll("input[type=range]").forEach(s => s.disabled = false);
        saveBtn.disabled = false;
        saveBtn.style.opacity = "1";
      }

      // ===== SAVE =====
      async function saveScores() {
        const team_code = teamSelect.value;
        if (!team_code) return;

        // Use the list we used to render
        const listToSave = window.currentCriteriaList || [];
        if (listToSave.length === 0) return;

        const scores = {};
        listToSave.forEach(c => {
          scores[c.criteria_code] = parseFloat(document.getElementById(c.criteria_code)?.value) || 0;
        });

        const effectiveJudgeId = judge_id.toUpperCase();

        try {
          const res = await fetch(API + "/scores", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ judge_id: effectiveJudgeId, team_code, scores }),
          });

          const data = await res.json();
          if (!res.ok || !data.success) throw new Error(data.message || "Save failed");

          // SUCCESS
          alert("‚úÖ Saved!");

          // Update local cache so we don't have to reload everything
          if (!myScoresCache[team_code]) myScoresCache[team_code] = {};
          Object.assign(myScoresCache[team_code], scores);

          // RE-RENDER DROPDOWN to unlock next team
          // We know this team is done now.
          // We can just re-run renderDropdown logic

          // Re-calculate "Done" set (inefficient but safe)
          const allDoneCodes = new Set(Object.keys(myScoresCache));
          renderDropdown(allDoneCodes);

          // Stop timer?
          if (isTimerRunning) {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerBtn.textContent = "‚è±Ô∏è Start 10m Timer";
            timerBtn.style.background = "#6c757d";
            timeRemaining = 600;
          }

        } catch (err) {
          console.error(err);
          alert("‚ùå Error: " + err.message);
        }
      }

      function logout() {
        localStorage.removeItem("judge_id");
        window.location.href = "index.html";
      }

      // Start
      init();
    </script>
</body>

</html>