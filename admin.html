<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äî Judging Dashboard</title>
  <style>
    :root {
      --brand: #004aad;
      --btn: #ffffff;
      --btnr: #ff0000;
      --btnb: #0063e5;
      --btn-hover: #68aeff;
      --bg: #ffffff;
      --card: #fff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #333;
    }

    header {
      background: var(--brand);
      color: #fff;
      padding: 14px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 12px rgba(0, 0, 0, .12);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
    }

    header .right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    main {
      padding: 0;
      flex: 1;
      overflow-y: auto;
      background: #fff;
    }

    .layout-container {
      display: flex;
      height: calc(100vh - 54px);
      /* Subtract header height */
      overflow: hidden;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 260px;
      background: #f8fafc;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 0 20px 15px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 0 12px;
    }

    /* Sidebar Buttons */
    .tbtn {
      display: flex;
      align-items: center;
      gap: 12px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      text-align: left;
      transition: all .2s ease;
      font-size: 14px;
    }

    .tbtn:hover {
      background: #f1f5f9;
      color: var(--brand);
    }

    .tbtn.active {
      background: var(--brand);
      color: #fff;
      font-weight: 600;
      box-shadow: 0 4px 6px -1px rgba(0, 74, 173, 0.2);
    }

    .tbtn .icon {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }

    /* Content Area Styles */
    .content-area {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* Panels */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      min-height: calc(100vh - 120px);
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    h2 {
      margin: 0 0 6px;
      color: var(--brand);
      font-size: 18px;
    }

    .muted {
      color: var(--muted);
      font-size: 14px;
    }

    /* Placeholder ‚Äúblank‚Äù states */
    .blank {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 26px;
      text-align: center;
      color: var(--muted);
      background: #fafafa;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    select,
    input,
    button {
      font-size: 15px;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .btn {
      background: var(--btn);
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: var(--btn-hover);
    }

    .btnr {
      background: var(--btnr);
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: var(--btn-hover);
    }

    .btnb {
      background: var(--btnb);
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: var(--btn-hover);
    }

    /* Tiny helper for section toolbars */
    .sectionbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 10px 0 16px;
    }

    .spacer {
      flex: 1;
    }

    /* --- Assign grid: three columns: team | nav buttons | judge --- */
    .assign-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 20px;
    }

    /* Side-by-side dropdowns (team + judge) */
    .assign-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-top: 16px;
    }

    .assign-col {
      flex: 1;
    }

    .assign-col select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .assign-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 16px;
    }

    .assign-top .assign-col {
      flex: 1;
    }

    .assign-top .assign-col.right {
      text-align: right;
    }

    .assign-top .assign-col.right select {
      width: 60%;
    }

    @media (max-width: 768px) {
      .assign-top {
        flex-direction: column;
        align-items: stretch;
      }

      .assign-top .assign-col.right select {
        width: 100%;
      }
    }

    /* Middle column: put buttons side-by-side, centered */
    .assign-nav {
      display: flex !important;
      flex-direction: column !important;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    /* In case a global .btn makes buttons block-level */
    .assign-nav .btn,
    .assign-nav button {
      width: 120px;
      height: 42px;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      min-width: 90px;
    }

    .blank-row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      height: 60vh;
    }

    .blank {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .btn-bar {
      display: flex;
      justify-content: right;
      gap: 20px;
    }

    .radio-list .radio-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      background: #fff;
    }

    /* Make team list adapt to screen height and scroll if long */
    #teamsList {
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 6px;
      scroll-behavior: smooth;
    }

    /* Optional: hide ugly scrollbar for better aesthetics (for WebKit browsers) */
    #teamsList::-webkit-scrollbar {
      width: 6px;
    }

    #teamsList::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 6px;
    }

    #teamsList::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }

    .radio-list .team-code {
      font-weight: 600;
      min-width: 80px;
      color: #1f2937;
    }

    .radio-list .team-name {
      color: #374151;
    }

    .radio-list input[type=checkbox] {
      transform: scale(1.1);
    }

    .assign-top {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      margin-bottom: 16px;
    }

    .assign-top .assign-col {
      flex: 1;
    }

    .assign-boards {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      /* left | middle | right */
      gap: 20px;
      align-items: stretch;
    }

    .list {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }

    .list-title {
      font-weight: 700;
      color: #334155;
      margin: 4px 6px 8px;
    }

    .scroll {
      overflow-y: auto;
      max-height: 50vh;
      padding-right: 6px;
    }

    .scroll::-webkit-scrollbar {
      width: 6px;
    }

    .scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 6px;
    }

    .scroll::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .assign-nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
      justify-content: center;
      align-items: center;
    }

    .assign-nav button {
      width: 120px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .radio-list .radio-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .radio-list .team-code {
      font-weight: 600;
      min-width: 80px;
      color: #1f2937;
    }

    .radio-list input[type=checkbox] {
      transform: scale(1.1);
    }

    @media (max-width:820px) {
      .assign-top {
        flex-direction: column;
        align-items: stretch;
      }

      .assign-boards {
        grid-template-columns: 1fr;
      }

      .assign-nav {
        flex-direction: row;
      }
    }

    .user-input {
      margin-top: 16px;
    }

    .user-input label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .user-input input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 15px;
    }

    .user-input input:focus {
      border-color: var(--brand);
      outline: none;
    }

    /* START MICKY */

    /* Score Viewer Tab */
    .team-card {
      border: 1px solid #ddd;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .team-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .btn {
      margin-top: 8px;
      padding: 6px 12px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn:hover {
      background: #2980b9;
    }

    .empty,
    .error {
      color: #e74c3c;
      font-style: italic;
    }

    .teams-table select {
      width: 100%;
      padding: 4px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 13px;
      background: white;
    }

    .teams-table select:hover {
      border-color: #94a8ff;
    }

    /* END MICKY */
  </style>
</head>

<body>
  <header>
    <h1>Admin ‚Äî Judging Dashboard</h1>
    <div class="right">
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="layout-container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="muted" style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Navigation</span>
      </div>
      <nav class="sidebar-nav" role="tablist" aria-label="Admin actions">
        <button id="btnTeams" class="tbtn" role="tab" aria-controls="panelTeams" aria-selected="false">
          <span class="icon">üë•</span> Team List
        </button>
        <button id="btnJudges" class="tbtn" role="tab" aria-controls="panelJudges" aria-selected="false">
          <span class="icon">‚öñÔ∏è</span> Judges List
        </button>
        <button id="btnAssign" class="tbtn" role="tab" aria-controls="panelAssign" aria-selected="false">
          <span class="icon">üîó</span> Assign Teams
        </button>
        <button id="btnQuestion" class="tbtn" role="tab" aria-controls="panelQuestion" aria-selected="false">
          <span class="icon">‚ùì</span> Create a Question
        </button>
        <button id="btnViewer" class="tbtn" role="tab" aria-controls="panelViewer" aria-selected="false">
          <span class="icon">üìä</span> Score Viewer
        </button>
        <button id="btnResults" class="tbtn" role="tab" aria-controls="panelResults" aria-selected="false">üèÜ Tier-1
          Results</button>
        <button id="btnVoting" class="tbtn" role="tab" aria-controls="panelVoting" aria-selected="false">üó≥Ô∏è Voting
          Status</button>
      </nav>
    </aside>

    <main id="mainContent">
      <div class="content-area">

        <section id="panelAssign" class="panel card" role="tabpanel" aria-labelledby="btnAssign">
          <h2>Assign Teams</h2>

          <!-- Top row: Team Categories (left) + Judge Names (right) -->
          <div class="assign-top">
            <div class="assign-col">
              <label class="muted" for="category">Team Categories</label>
              <select id="category">
                <option value="">‚Äî Select a category ‚Äî</option>
                <option value="Inno-Tech Primary Software">Inno-Tech Primary Software</option>
                <option value="Inno-Tech Primary Hardware">Inno-Tech Primary Hardware</option>
                <option value="Inno-Tech Secondary Software">Inno-Tech Secondary Software</option>
                <option value="Inno-Tech Secondary Hardware">Inno-Tech Secondary Hardware</option>
                <option value="Inno-Maker Primary">Inno-Maker Primary</option>
                <option value="Inno-Maker Secondary">Inno-Maker Secondary</option>
                <option value="Tech-Hackathon Primary">Tech-Hackathon Primary</option>
                <option value="Tech-Hackathon Secondary">Tech-Hackathon Secondary</option>
              </select>
            </div>

            <div class="assign-col">
              <label class="muted" for="judgeSelect">Judge Names</label>
              <select id="judgeSelect">
                <option value="">‚Äî Select judge ‚Äî</option>
                <!-- Voting Status Panel -->
                <div id="panelVoting" role="tabpanel" aria-labelledby="btnVoting" hidden>
                  <div class="panel-header">
                    <h2>Voting Status</h2>
                    <button id="btnRefreshVoting" class="action-btn">üîÑ Refresh</button>
                  </div>
                  <div class="voting-summary-cards">
                    <div class="summary-card">
                      <h3>Total Teams Voted</h3>
                      <p id="totalVotesCount">Loading...</p>
                    </div>
                    <div class="summary-card">
                      <h3>Participation Rate</h3>
                      <p id="vote participationRate">Loading...</p>
                    </div>
                  </div>

                  <div class="table-container">
                    <table class="teams-table" id="votingTable">
                      <thead>
                        <tr>
                          <th>Team Code</th>
                          <th>Team Name</th>
                          <th>Category</th>
                          <th>Status</th>
                        </tr>
                      </thead>
                      <tbody id="votingTableBody">
                        <!-- Rows will be populated here -->
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Tier 1 Results Panel -->
              </select>
            </div>
          </div>

          <!-- Boards: Available | Buttons | Assigned (under judge) -->
          <div class="assign-boards">
            <!-- LEFT: Available teams (checkbox, multi-select) -->
            <div class="list">
              <div class="list-title">Available Teams</div>
              <div id="teamsList" class="radio-list scroll"></div>
            </div>

            <!-- MIDDLE: Buttons -->
            <div class="assign-nav">
              <button class="btnb" id="btnAdd">‚û°Ô∏è Add</button>
              <button class="btnr" id="btnRemove">‚¨ÖÔ∏è Remove</button>
              <button type="button" id="btnSave" class="btnb">üíæ Save</button>
            </div>

            <!-- RIGHT: Assigned to selected judge (for selected category) -->
            <div class="list">
              <div class="list-title">
                Assigned <span id="assignedHeaderSuffix" class="muted"></span>
              </div>
              <div id="assignedList" class="radio-list scroll"></div>
            </div>
          </div>
        </section>

        <!-- If you want middle buttons + right list later, add them below as a separate row -->
        <!-- <div class="assign-boards"> ... </div> -->
        </section>

        <!-- <div class="blank" id="teamsBox">
      <div id="teamsList" class="radio-list"></div>
    </div> -->

        <!-- Right box: judges -->
        <!-- <div class="blank" id="judgesBox">
      <select id="judgeSelect">
        <option>Judge 1</option>
        <option>Judge 2</option>
      </select>
    </div>
  </div>
</div> -->

        </section>

        <section id="panelViewer" class="panel card" role="tabpanel" aria-labelledby="btnViewer">
          <h2>Score Viewer</h2>
          <div class="muted">Filter by team or judge to view saved scores. (This is a placeholder.)</div>

          <div class="sectionbar">
            <label class="muted" for="viewer-category">Team Categories</label>
            <select id="viewer-category">
              <option value="">‚Äî Select a category ‚Äî</option>
              <option value="Inno-Tech Primary Software">Inno-Tech Primary Software</option>
              <option value="Inno-Tech Primary Hardware">Inno-Tech Primary Hardware</option>
              <option value="Inno-Tech Secondary Software">Inno-Tech Secondary Software</option>
              <option value="Inno-Tech Secondary Hardware">Inno-Tech Secondary Hardware</option>
              <option value="Inno-Maker Primary">Inno-Maker Primary</option>
              <option value="Inno-Maker Secondary">Inno-Maker Secondary</option>
              <option value="Tech-Hackathon Primary">Tech-Hackathon Primary</option>
              <option value="Tech-Hackathon Secondary">Tech-Hackathon Secondary</option>
            </select>

            <label class="muted" for="viewer-type" style="margin-left: 20px;">Result Type</label>
            <select id="viewer-type">
              <option value="presentation">Presentation Scores</option>
              <option value="coding">Coding Results</option>
            </select>
            <div class="spacer"></div>
            <button class="btnr" id="exportBtn">‚¨áÔ∏è Export CSV</button>
          </div>

          <div class="team-list"></div>
        </section>

        <section>
          <section id="panelTeams" class="panel card" role="tabpanel" aria-labelledby="btnTeams">
            <h2>Team List</h2>
            <div class="muted">Browse and search teams.</div>

            <div class="sectionbar" id="newTeamBar" style="gap:.8rem; align-items:flex-end; flex-wrap: wrap;">

              <div style="display: flex; flex-direction: column; gap: 4px;">
                <label class="muted" style="font-size: 11px;">Category</label>
                <select id="teamCategoryFilterAdd" style="max-width: 14rem;">
                  <option value="">‚Äî Select category ‚Äî</option>
                  <option value="Inno-Tech Primary Software">Inno-Tech Primary Software</option>
                  <option value="Inno-Tech Primary Hardware">Inno-Tech Primary Hardware</option>
                  <option value="Inno-Tech Secondary Software">Inno-Tech Secondary Software</option>
                  <option value="Inno-Tech Secondary Hardware">Inno-Tech Secondary Hardware</option>
                  <option value="Inno-Maker Primary">Inno-Maker Primary</option>
                  <option value="Inno-Maker Secondary">Inno-Maker Secondary</option>
                  <option value="Tech-Hackathon Primary">Tech-Hackathon Primary</option>
                  <option value="Tech-Hackathon Secondary">Tech-Hackathon Secondary</option>
                </select>
              </div>

              <div
                style="display: flex; flex-direction: column; gap: 4px; border-left: 1px solid #ddd; padding-left: 12px;">
                <label class="muted" style="font-size: 11px;">Team Code</label>
                <span id="nt_next_code"
                  style="font-weight: bold; color: var(--brand); font-size: 1rem; min-width: 6rem; height: 38px; display: flex; align-items: center; padding: 0 12px; background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; box-sizing: border-box;">‚Äî</span>
              </div>

              <div style="display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 12rem;">
                <label class="muted" style="font-size: 11px;">Team Name</label>
                <input id="nt_team_name" type="text" placeholder="e.g. Dream Team">
              </div>

              <div style="display: flex; flex-direction: column; gap: 4px; flex: 2; min-width: 18rem;">
                <label class="muted" style="font-size: 11px;">Student Names (comma separated)</label>
                <input id="nt_members" type="text" placeholder="e.g. Alice, Bob, Charlie">
              </div>

              <div style="display: flex; flex-direction: column; gap: 4px;">
                <label class="muted" style="font-size: 11px; visibility: hidden;">Action</label>
                <button class="tbtn" id="nt_submit" style="padding: 0 20px; height: 38px;">‚ûï Add Team</button>
              </div>
              <div class="spacer"></div>
              <span id="newTeamStatus" class="muted" style="min-width: 10rem;"></span>
            </div>

            <div class="sectionbar">
              <label class="muted" for="category">Team Categories</label>
              <select id="teamCategoryFilter">
                <option value="">‚Äî Select a category ‚Äî</option>
                <option value="Inno-Tech Primary Software">Inno-Tech Primary Software</option>
                <option value="Inno-Tech Primary Hardware">Inno-Tech Primary Hardware</option>
                <option value="Inno-Tech Secondary Software">Inno-Tech Secondary Software</option>
                <option value="Inno-Tech Secondary Hardware">Inno-Tech Secondary Hardware</option>
                <option value="Inno-Maker Primary">Inno-Maker Primary</option>
                <option value="Inno-Maker Secondary">Inno-Maker Secondary</option>
                <option value="Tech-Hackathon Primary">Tech-Hackathon Primary</option>
                <option value="Tech-Hackathon Secondary">Tech-Hackathon Secondary</option>
              </select>
              <div class="spacer"></div>
              <button id="exportTeamsBtn" class="btnr">‚¨áÔ∏è Export CSV</button>
            </div>

            <section id="teamListPanel" style="margin-top:1rem;">
              <div id="teamListStatus" style="font-size:0.9rem;color:#666;"></div>
              <div id="teamListContainer"
                style="overflow:auto; max-height:420px; border:1px solid #ddd; border-radius:8px;"></div>
            </section>
          </section>
        </section>

        <section id="panelJudges" class="panel card" role="tabpanel" aria-labelledby="btnJudges">
          <h2>Judges List</h2>
          <div class="sectionbar" id="newJudgeBar" style="gap:.5rem; align-items:center;">
            <button class="tbtn" id="btnJudgesRefresh">‚ü≥ Refresh</button>

            <input id="nj_judge_id" type="text" placeholder="JUDGE ID (e.g. J-001)" style="max-width:8rem;">
            <input id="nj_judge_name" type="text" placeholder="JUDGE NAME" style="max-width:14rem;">

            <button class="tbtn" id="nj_submit">‚ûï Add</button>

            <div class="spacer"></div>
            <span id="newJudgeStatus" class="muted" style="min-width:12rem;"></span>
            <button id="exportJudgesBtn" class="btnr">‚¨áÔ∏è Export CSV</button>
          </div>

          <section id="judgeListPanel" style="margin-top:1rem;">
            <div id="judgeListStatus" style="font-size:0.9rem;color:#666;"></div>
            <div id="judgeListContainer"
              style="overflow:auto; max-height:420px; border:1px solid #ddd; border-radius:8px;">
            </div>
          </section>
        </section>


        <section id="panelQuestion" class="panel card" role="tabpanel" aria-labelledby="btnQuestion">
          <h2>Create Questions Form</h2>
          <h4>You are about to create a Hackathon Question, please go through everything carefully to avoid any mix-ups.
          </h4>
          <div class="sectionbar" id="newQuestionBar" style="gap:.5rem; align-items:center;">


            <div class="user-input">

              <label for="Question Code">üíª Question Code</label>
              <input id="nq_question_code" type="text" name="Question Code" placeholder="Question code (e.g. Q002)"
                style="max-width:14rem;">

              <div class="assign-col">
                <label class="muted" name="Marks" for="MarkSelect">üíØ Difficulty Level</label>
                <select id="MarkSelect" style="max-width: 14rem;">
                  <option value="">‚Äî Select Difficulty ‚Äî</option>
                  <option value="Easy"> Super Easy 2% </option>
                  <option value="Normal"> Easy 5% </option>
                  <option value="Hard"> Normal 7% </option>
                  <option value="Extreme"> Hard 10% </option>
                </select>
              </div>

              <label for="Title">‚úèÔ∏è Title:</label>
              <input type="text" id="nq_question_title" name="Title" placeholder="Enter your title here..."
                style="width:50rem" />
              <label for="Problem Statement"> üß© Problem Statement:</label>
              <textarea type="text" id="nq_question_statement" name="Problem Statement"
                placeholder="Enter your Statement here..." style="width:50rem; height: 14rem;"></textarea>
              <h3>üìù Test Cases</h3>
              <label for="Test Case1">Test Case 1:</label>
              <textarea id="nq_question_input1" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out1" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case2">Test Case 2:</label>
              <textarea id="nq_question_input2" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out2" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case3">Test Case 3:</label>
              <textarea id="nq_question_input3" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out3" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case4">Test Case 4:</label>
              <textarea id="nq_question_input4" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out4" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case5">Test Case 5:</label>
              <textarea id="nq_question_input5" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out5" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case6">Test Case 6:</label>
              <textarea id="nq_question_input6" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out6" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case7">Test Case 7:</label>
              <textarea id="nq_question_input7" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out7" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case8">Test Case 8:</label>
              <textarea id="nq_question_input8" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out8" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case9">Test Case 9:</label>
              <textarea id="nq_question_input9" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out9" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <label for="Test Case10">Test Case 10:</label>
              <textarea id="nq_question_input10" type="text" placeholder="Input..."
                style="width:25rem; height:15rem"></textarea>
              <textarea id="nq_question_out10" type="text" placeholder="Output..."
                style="width:25rem; height:15rem"></textarea>
              <button class="tbtn" id="btnQuestionRefresh">‚ü≥ Refresh</button>
              <button class="tbtn" id="nq_submit">‚ûï Submit</button>
              <p id="questionStatus" style="margin-top:10px; font-weight:600; color:#555;"></p>
              <!-- Status message appears here -->
            </div>



            <div class="spacer"></div>
            <span id="newQuestionStatus" class="muted" style="min-width:12rem;"></span>
          </div>

          <!-- Student list display -->
          <section id="questionListPanel" style="margin-top:1rem;">
            <div id="questionListStatus" style="font-size:0.9rem;color:#666;"></div>
            <div id="questionListContainer"
              style="overflow:auto; max-height:420px; border:1px solid #ddd; border-radius:8px;"></div>
          </section>

      </div>
    </main>
  </div>

  <script>
    const API = "https://judging-system.yeewengloke.workers.dev";

    // Session check
    if (localStorage.getItem("isAdmin") !== "true") {
      window.location.href = "index.html";
    }

    // Global Constants & State
    const JUDGES_API = `${API}/judges`;
    const STUDENTS_API = `${API}/student_accounts`; // Base for students if needed
    let allJudges = [];

    /* ===============================
       1. Panel Switching (Toolbar)
    ================================*/
    const tabs = [
      { btn: 'btnTeams', panel: 'panelTeams' },
      { btn: 'btnJudges', panel: 'panelJudges' },
      { btn: 'btnAssign', panel: 'panelAssign' },
      { btn: 'btnQuestion', panel: 'panelQuestion' },
      { btn: 'btnViewer', panel: 'panelViewer' },
      { btn: 'btnResults', panel: 'panelResults' },
      { btn: 'btnVoting', panel: 'panelVoting' }
    ];

    async function populateAssignJudgeDropdown() {
      if (!judgeSel) return;
      // show a loading option
      judgeSel.innerHTML = `<option value="">Loading‚Ä¶</option>`;
      try {
        const res = await fetch(JUDGES_API, { headers: { 'Accept': 'application/json' } });
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.results || data.judges || []);

        judgeSel.innerHTML = `<option value="">‚Äî Select judge ‚Äî</option>` +
          list.map(j => {
            const label = j.judge_name || j.username || j.judge_id;
            return `<option value="${j.judge_id}">${label}</option>`;
          }).join("");
      } catch (e) {
        console.error(e);
        judgeSel.innerHTML = `<option value="">Failed to load judges</option>`;
      }
    }

    function showPanel(panelId, btnId) {
      tabs.forEach(({ btn }) => {
        const el = document.getElementById(btn);
        if (!el) return;
        const active = btn === btnId;
        el.classList.toggle('active', active);
        el.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      tabs.forEach(({ panel }) => {
        const el = document.getElementById(panel);
        if (!el) return;
        el.classList.toggle('active', panel === panelId);
        el.hidden = !(panel === panelId); // Hide/show panels
      });
    }

    tabs.forEach(({ btn, panel }) => {
      const b = document.getElementById(btn);
      b?.addEventListener('click', () => showPanel(panel, btn));
      b?.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showPanel(panel, btn); }
      });
    });

    // Optionally open Teams tab on load
    showPanel('panelTeams', 'btnTeams');

    // When switching tabs, if Team List tab is clicked, load teams
    document.getElementById('btnTeams')?.addEventListener('click', () => {
      loadTeams();
    });

    document.getElementById('btnTeamRefresh')?.addEventListener('click', loadTeams);

    let teamListLoadedOnce = false;
    document.getElementById('btnTeams')?.addEventListener('click', () => {
      if (!teamListLoadedOnce) {
        teamListLoadedOnce = true;
        loadTeams();
      }
    });

    document.getElementById('btnAssign')?.addEventListener('click', async () => {
      populateAssignJudgeDropdown();
      if (currentJudgeId) {
        await loadAssignmentsForJudge(currentJudgeId);
        if (currentCategory) await loadTeamsForCategory(currentCategory);
      }
    });


    // If you have an Assign refresh button:
    document.getElementById('btnAssignRefresh')?.addEventListener('click', () => {
      populateAssignJudgeDropdown();
    });

    /* ===============================
       2. Assign Teams Logic
    ================================*/
    const catSel = document.getElementById("category");
    const judgeSel = document.getElementById("judgeSelect");
    const teamsListEl = document.getElementById("teamsList");     // left
    const assignedEl = document.getElementById("assignedList");  // right
    const headerSuffix = document.getElementById("assignedHeaderSuffix");
    const btnAdd = document.getElementById("btnAdd");
    const btnRemove = document.getElementById("btnRemove");

    const teamsByCategory = {};
    const assignedByJudge = {};
    let availableTeams = [];
    let currentCategory = "";
    let currentJudgeId = "";

    // --- utilities ---
    function prefixForCategory(cat) {
      if (cat === "Inno-Tech Primary Software") return "ITPS";
      if (cat === "Inno-Tech Primary Hardware") return "ITPH";
      if (cat === "Inno-Tech Secondary Software") return "ITSS";
      if (cat === "Inno-Tech Secondary Hardware") return "ITSH";
      if (cat === "Inno-Maker Primary") return "IMP";
      if (cat === "Inno-Maker Secondary") return "IMS";
      if (cat === "Tech-Hackathon Primary") return "THP";
      if (cat === "Tech-Hackathon Secondary") return "THS";
      return "";
    }
    function teamRow(t, name) {
      return `
    <label class="radio-item">
      <input type="checkbox" name="${name}" value="${t.team_code}">
      <span class="team-code">${t.team_code}</span>
      <span class="team-name">${t.team_name ?? ""}</span>
    </label>`;
    }
    function renderLeft() {
      teamsListEl.innerHTML = availableTeams.length
        ? availableTeams.map(t => teamRow(t, "leftPick")).join("")
        : `<div class="muted" style="padding:8px 0;">No available teams.</div>`;
    }
    function renderRight() {
      const allAssigned = assignedByJudge[currentJudgeId] || [];
      const pref = prefixForCategory(currentCategory);
      const rightForCategory = allAssigned.filter(t => (t.team_code || "").startsWith(pref));
      assignedEl.innerHTML = rightForCategory.length
        ? rightForCategory.map(t => teamRow(t, "rightPick")).join("")
        : `<div class="muted" style="padding:8px 0;">No teams assigned to this judge for ${currentCategory || "this category"}.</div>`;
      headerSuffix.textContent = currentJudgeId
        ? `for ${currentCategory || "category"}`
        : "";
    }
    function getCheckedValues(name) {
      return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(x => x.value);
    }
    function uniqueByTeam(arr) {
      const m = new Map();
      arr.forEach(t => m.set(t.team_code, t));
      return Array.from(m.values());
    }

    // === HYDRATE: pull current assignments for a judge from DB ===
    async function loadAssignmentsForJudge(judgeId) {
      if (!judgeId) return;
      const res = await fetch(`${API}/assigned-teams?judge_id=${encodeURIComponent(judgeId)}`);
      const rows = await res.json();
      assignedByJudge[judgeId] = Array.isArray(rows) ? rows : (rows.results || []);
    }


    //START MICKY

    // DOM elements
    const viewerCategorySelect = document.getElementById('viewer-category');
    const viewerteamListContainer = document.querySelector('.team-list');
    const exportBtn = document.querySelector('#panelViewer .btnr');

    let allTeams = [];
    let cachedContestResults = []; // Cache the results so they persist

    async function fetchTeams() {
      console.log("üîÑ fetchTeams called");
      try {
        // 1. Fetch Teams
        const resTeams = await fetch(`${API}/teams`);
        const teamsData = await resTeams.json();
        allTeams = Array.isArray(teamsData) ? teamsData : (teamsData.results || []);

        // 2. Fetch All Scores (for auto-calculation)
        let scoreMap = {};
        try {
          const resScores = await fetch(`${API}/all-scores`);
          if (resScores.ok) {
            const allScores = await resScores.json();
            // Group by team -> criteria
            allScores.forEach(s => {
              if (!scoreMap[s.team_code]) scoreMap[s.team_code] = {};
              if (!scoreMap[s.team_code][s.criteria_code]) scoreMap[s.team_code][s.criteria_code] = [];
              scoreMap[s.team_code][s.criteria_code].push(parseFloat(s.score));
            });
          }
        } catch (e) { console.warn("Could not fetch scores for auto-calc", e); }

        // 3. Merge Scores into Teams (Trimmed Mean Logic)
        allTeams = allTeams.map(team => {
          const scores = scoreMap[team.team_code];
          if (!scores) return team; // No scores yet

          let totalScore = 0;

          // Extended Criteria Mapping
          // IM (Inno-Maker): C001-C006
          // IT (Inno-Tech): T001-T005
          const criteriaKeys = {
            // Inno-Maker
            'C001': 'final_creativity',
            'C002': 'final_practical',
            'C003': 'final_social',
            'C004': 'final_cost',
            'C005': 'final_sustainability', // New C005
            'C006': 'final_presentation',   // New C006

            // Inno-Tech
            'T001': 'final_t1', // Basic Coding
            'T002': 'final_t2', // Explain Code
            'T003': 'final_t3', // System Flow
            'T004': 'final_t4', // Script Test
            'T005': 'final_t5'  // API Usage
          };

          for (const [cCode, valArr] of Object.entries(scores)) {
            let finalArr = valArr;
            // OUTLIER LOGIC: If >= 4 judges, drop min and max
            if (valArr.length >= 4) {
              valArr.sort((a, b) => a - b);
              finalArr = valArr.slice(1, valArr.length - 1);
            }

            const sum = finalArr.reduce((a, b) => a + b, 0);
            const avg = finalArr.length > 0 ? sum / finalArr.length : 0;

            const key = criteriaKeys[cCode];
            if (key) team[key] = avg;

            totalScore += avg;
          }
          team.final_score = totalScore;
          return team;
        });

        renderCurrentView();

      } catch (err) {
        console.error(err);
        document.querySelector('.team-list').innerHTML = `<div class="error">Failed to load teams: ${err.message}</div>`;
      }
    }

    // Helper function to merge contest scores (kept for legacy if needed)
    function mergeScoresIntoTeams() {
      // This function is kept for backward compatibility if other parts call it, 
      // but the main scoring logic is now in fetchTeams.
      // We can add the legacy 'contest results' logic here if needed.
      if (typeof cachedContestResults !== 'undefined' && cachedContestResults.length > 0) {
        const resultsMap = {};
        cachedContestResults.forEach(r => {
          if (r && r.team_code) {
            if (!resultsMap[r.team_code] || r.total_score > resultsMap[r.team_code].total_score) {
              resultsMap[r.team_code] = r;
            }
          }
        });

        allTeams.forEach(team => {
          if (resultsMap[team.team_code]) {
            team.contest_score = resultsMap[team.team_code].total_score;
            team.contest_time = resultsMap[team.team_code].total_time;
          }
        });
      }
    }

    function renderTeams(teams) {
      if (!teams || teams.length === 0) {
        viewerteamListContainer.innerHTML = '<p class="empty">No teams found.</p>';
        return;
      }

      const viewType = document.getElementById('viewer-type')?.value || 'presentation';
      const currentCategory = viewerCategorySelect.value || "";

      // Determine view mode
      const isMixed = !currentCategory;
      const isIT = currentCategory.toLowerCase().includes('inno-tech');

      const awardOptions = [
        "",
        "champion",
        "1st runner up",
        "2nd runner up",
        "3rd runner up",
        "4th runner up",
        "The Best Presentation Award",
        "The Outstanding Tech Award",
        "The Most Popular Award",
        "The Sustainability Idea Award",
        "The Entrepreneurial Award"
      ];
      const gradeOptions = ["", "titanium", "gold", "silver", "bronze"];

      // Helper to generate selects
      const getSelects = (team) => {
        const currentAward = team.award || "";
        const currentGrade = team.grade || "";
        const awardSelect = `
          <select class="award-select" data-team-code="${team.team_code}">
            ${awardOptions.map(opt =>
          `<option value="${opt}" ${opt === currentAward ? 'selected' : ''}>${opt || "‚Äî No award ‚Äî"}</option>`).join('')}
          </select>`;
        const gradeSelect = `
          <select class="grade-select" data-team-code="${team.team_code}">
            ${gradeOptions.map(opt =>
          `<option value="${opt}" ${opt === currentGrade ? 'selected' : ''}>${opt || "‚Äî No grade ‚Äî"}</option>`).join('')}
          </select>`;
        return { awardSelect, gradeSelect };
      };

      const fmt = (n) => (n != null && typeof n === 'number') ? n.toFixed(2) : '‚Äî';

      // headers
      const headersIT = `
          <thead>
            <tr>
              <th>Code</th>
              <th>Team Name</th>
              <th>Students</th>
              <th>Basic Code (T1)</th>
              <th>Explain (T2)</th>
              <th>Flow (T3)</th>
              <th>Test (T4)</th>
              <th>API (T5)</th>
              <th>Final Score</th>
              <th>Award</th>
              <th>Grade</th>
            </tr>
          </thead>`;

      const headersIM = `
          <thead>
            <tr>
              <th>Code</th>
              <th>Team Name</th>
              <th>Students</th>
              <th>Creativity</th>
              <th>Practical</th>
              <th>Social</th>
              <th>Cost</th>
              <th>Sustain.</th>
              <th>Pres.</th>
              <th>Final Score</th>
              <th>Award</th>
              <th>Grade</th>
            </tr>
          </thead>`;

      const headersCoding = `
          <thead>
            <tr>
              <th>Team Code</th>
              <th>Team Name</th>
              <th>Category</th>
              <th>Students</th>
              <th style="background: #fef2f2;">Coding Score</th>
              <th>Time Taken</th>
            </tr>
          </thead>`;


      // Row Generators
      const renderRowIT = (team) => {
        const { awardSelect, gradeSelect } = getSelects(team);
        return `
            <tr data-team-code="${team.team_code}">
              <td>${team.team_code || '‚Äî'}</td>
              <td>${team.team_name || '‚Äî'}</td>
              <td><div style="font-size: 11px; white-space: pre-wrap; max-width: 150px;">${team.student_names || '‚Äî'}</div></td>
              <td>${fmt(team.final_t1)}</td>
              <td>${fmt(team.final_t2)}</td>
              <td>${fmt(team.final_t3)}</td>
              <td>${fmt(team.final_t4)}</td>
              <td>${fmt(team.final_t5)}</td>
              <td><strong>${fmt(team.final_score)}</strong></td>
              <td>${awardSelect}</td>
              <td>${gradeSelect}</td>
            </tr>`;
      };

      const renderRowIM = (team) => {
        const { awardSelect, gradeSelect } = getSelects(team);
        return `
            <tr data-team-code="${team.team_code}">
              <td>${team.team_code || '‚Äî'}</td>
              <td>${team.team_name || '‚Äî'}</td>
              <td><div style="font-size: 11px; white-space: pre-wrap; max-width: 150px;">${team.student_names || '‚Äî'}</div></td>
              <td>${fmt(team.final_creativity)}</td>
              <td>${fmt(team.final_practical)}</td>
              <td>${fmt(team.final_social)}</td>
              <td>${fmt(team.final_cost)}</td>
              <td>${fmt(team.final_sustainability)}</td>
              <td>${fmt(team.final_presentation)}</td>
              <td><strong>${fmt(team.final_score)}</strong></td>
              <td>${awardSelect}</td>
              <td>${gradeSelect}</td>
            </tr>`;
      };

      const renderRowCoding = (team) => {
        return `
            <tr data-team-code="${team.team_code}">
              <td>${team.team_code || '‚Äî'}</td>
              <td>${team.team_name || '‚Äî'}</td>
              <td>${team.category || '‚Äî'}</td>
              <td><div style="font-size: 11px; white-space: pre-wrap; max-width: 150px;">${team.student_names || '‚Äî'}</div></td>
              <td style="background: #fdf2f2; font-weight: bold; color: #991b1b;">${(team.contest_score != null) ? team.contest_score + '%' : '‚Äî'}</td>
              <td>${team.contest_time || '‚Äî'}</td>
            </tr>`;
      };


      // RENDER LOGIC
      if (viewType === 'coding') {
        // Simple single table
        const rows = teams.map(renderRowCoding).join('');
        viewerteamListContainer.innerHTML = `<div style="overflow-x: auto;"><table class="teams-table">${headersCoding}<tbody>${rows}</tbody></table></div>`;
        return;
      }

      if (isMixed) {
        // Split into IT and IM
        const itTeams = teams.filter(t => (t.category || '').toLowerCase().includes('inno-tech'));
        const imTeams = teams.filter(t => !(t.category || '').toLowerCase().includes('inno-tech'));

        let html = '';

        // 1. Render IT Table
        if (itTeams.length > 0) {
          html += `<h3 style="margin-bottom:10px; color:#1e293b;">Inno-Tech Categories (IT/IS)</h3>`;
          html += `<div style="overflow-x: auto; margin-bottom: 40px;">
                      <table class="teams-table">
                        ${headersIT}
                        <tbody>${itTeams.map(renderRowIT).join('')}</tbody>
                      </table>
                     </div>`;
        }

        // 2. Render IM Table
        if (imTeams.length > 0) {
          html += `<h3 style="margin-bottom:10px; color:#1e293b;">Inno-Maker Categories (IM)</h3>`;
          html += `<div style="overflow-x: auto;">
                        <table class="teams-table">
                          ${headersIM}
                          <tbody>${imTeams.map(renderRowIM).join('')}</tbody>
                        </table>
                      </div>`;
        }

        if (itTeams.length === 0 && imTeams.length === 0) {
          html = '<p class="empty">No active teams found.</p>';
        }

        viewerteamListContainer.innerHTML = html;

      } else {
        // Specific Category Selected
        if (isIT) {
          const rows = teams.map(renderRowIT).join('');
          viewerteamListContainer.innerHTML = `<div style="overflow-x: auto;"><table class="teams-table">${headersIT}<tbody>${rows}</tbody></table></div>`;
        } else {
          const rows = teams.map(renderRowIM).join('');
          viewerteamListContainer.innerHTML = `<div style="overflow-x: auto;"><table class="teams-table">${headersIM}<tbody>${rows}</tbody></table></div>`;
        }
      }


      viewerteamListContainer.querySelectorAll('.award-select').forEach(select => {
        select.addEventListener('change', handleAwardChange);
      });
      viewerteamListContainer.querySelectorAll('.grade-select').forEach(select => {
        select.addEventListener('change', handleGradeChange);
      });
    }

    viewerCategorySelect?.addEventListener('change', () => {
      renderCurrentView();
    });

    document.getElementById('viewer-type')?.addEventListener('change', () => {
      renderCurrentView();
    });

    function renderCurrentView() {
      const selectedCategory = viewerCategorySelect.value;
      const viewType = document.getElementById('viewer-type')?.value || 'presentation';

      // Re-merge scores
      mergeScoresIntoTeams();

      let filtered = selectedCategory
        ? allTeams.filter(team => team.category === selectedCategory)
        : allTeams;

      if (viewType === 'coding') {
        filtered = filtered.filter(team => (team.category || '').startsWith("Tech-Hackathon"));
      }

      renderTeams(filtered);
    }

    async function handleAwardChange(e) {
      const teamCode = e.target.dataset.teamCode;
      const award = e.target.value || null;
      try {
        const res = await fetch(`${API}/teams/${teamCode}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ award })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        console.log(`Award saved for ${teamCode}:`, award || "none");
      } catch (err) {
        console.error("Failed to save award:", err);
        alert("‚ùå Failed to save award. Check console.");
      }
    }

    async function handleGradeChange(e) {
      const teamCode = e.target.dataset.teamCode;
      const grade = e.target.value || null;
      try {
        const res = await fetch(`${API}/teams/${teamCode}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ grade })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        console.log(`Grade saved for ${teamCode}:`, grade || "none");
      } catch (err) {
        console.error("Failed to save grade:", err);
        alert("‚ùå Failed to save grade. Check console.");
      }
    }

    exportBtn?.addEventListener('click', () => {
      const selectedCategory = viewerCategorySelect.value;
      const viewType = document.getElementById('viewer-type')?.value || 'presentation';
      const isCoding = viewType === 'coding';

      let teamsToExport = selectedCategory
        ? allTeams.filter(team => team.category === selectedCategory)
        : allTeams;

      if (isCoding) {
        teamsToExport = teamsToExport.filter(team => (team.category || '').startsWith("Tech-Hackathon"));
      }

      if (!teamsToExport || teamsToExport.length === 0) {
        alert("No teams to export.");
        return;
      }

      // Define columns in order
      const headers = isCoding ? [
        "Team Code",
        "Team Name",
        "Category",
        "Coding Score",
        "Time Taken"
      ] : [
        "Team Code",
        "Team Name",
        "Category",
        "Creativity",
        "Practical",
        "Social",
        "Cost",
        "Presentation",
        "Final Score",
        "Award",
        "Grade"
      ];

      // Build CSV rows
      const rows = teamsToExport.map(team => {
        if (isCoding) {
          return [
            `"${(team.team_code || '').replace(/"/g, '""')}"`,
            `"${(team.team_name || '').replace(/"/g, '""')}"`,
            `"${(team.category || '').replace(/"/g, '""')}"`,
            team.contest_score != null ? team.contest_score + "%" : "‚Äî",
            `"${(team.contest_time || '').replace(/"/g, '""')}"`
          ].join(",");
        } else {
          return [
            `"${(team.team_code || '').replace(/"/g, '""')}"`,
            `"${(team.team_name || '').replace(/"/g, '""')}"`,
            `"${(team.category || '').replace(/"/g, '""')}"`,
            team.final_creativity != null ? team.final_creativity.toFixed(2) : "",
            team.final_practical != null ? team.final_practical.toFixed(2) : "",
            team.final_social != null ? team.final_social.toFixed(2) : "",
            team.final_cost != null ? team.final_cost.toFixed(2) : "",
            team.final_presentation != null ? team.final_presentation.toFixed(2) : "",
            team.final_score != null ? team.final_score.toFixed(2) : "",
            `"${(team.award || '').replace(/"/g, '""')}"`,
            `"${(team.grade || '').replace(/"/g, '""')}"`,
          ].join(",");
        }
      });

      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", "score_viewer_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    // --- Calculate Final Results ---
    document.getElementById('calcBtn')?.addEventListener('click', async () => {
      const btn = document.getElementById('calcBtn');
      if (!confirm("This will recalculate final scores for ALL teams based on all judge submissions. This may take a few seconds.\n\nContinue?")) return;

      btn.disabled = true;
      btn.textContent = "Calculating...";
      try {
        const res = await fetch(`${API}/calculate-results`, { method: 'POST' });
        const data = await res.json();

        if (!res.ok || !data.success) throw new Error(data.error || "Unknown error");

        alert(`‚úÖ Calculation Complete!\n\nProcessed ${data.teams_processed} teams.\nUpdated scores for ${data.teams_updated} teams.`);
        fetchTeams(); // Refresh table
      } catch (e) {
        console.error(e);
        alert("‚ùå Calculation Failed: " + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "üßÆ Calculate Final Results";
      }
    });

    // Load on init
    fetchTeams();

    //END MICKY 

    // --- load data ---
    async function loadJudges() {
      try {
        const res = await fetch(`${API}/judges`);
        const data = await res.json();
        judgeSel.innerHTML = `<option value="">‚Äî Select judge ‚Äî</option>` +
          data.map(j => `<option value="${j.judge_id}">${j.judge_name || j.judge_id}</option>`).join("");
      } catch (e) {
        console.error(e);
        judgeSel.innerHTML = `<option value="">Failed to load judges</option>`;
      }
    }

    async function loadTeamsForCategory(category) {
      if (!teamsByCategory[category]) {
        const url = new URL(`${API}/teams`);
        url.searchParams.set("category", category);
        const res = await fetch(url);
        const data = await res.json();
        const pref = prefixForCategory(category);
        teamsByCategory[category] = data.filter(t => (t.team_code || "").startsWith(pref));
      }

      currentCategory = category;
      const pref = prefixForCategory(category);
      const allInCat = teamsByCategory[category] || [];
      const assignedSet = new Set((assignedByJudge[currentJudgeId] || [])
        .filter(t => (t.team_code || "").startsWith(pref))
        .map(t => t.team_code));
      availableTeams = allInCat.filter(t => !assignedSet.has(t.team_code));

      renderLeft();
      renderRight();
    }

    // --- add/remove actions ---
    btnAdd.addEventListener("click", async () => {
      if (!currentJudgeId) { alert("Please select a judge."); return; }
      if (!currentCategory) { alert("Please select a category."); return; }

      const picks = getCheckedValues("leftPick");
      if (picks.length === 0) { alert("Select one or more teams on the left."); return; }

      const move = availableTeams.filter(t => picks.includes(t.team_code));
      assignedByJudge[currentJudgeId] = uniqueByTeam([
        ...(assignedByJudge[currentJudgeId] || []),
        ...move
      ]);
      availableTeams = availableTeams.filter(t => !picks.includes(t.team_code));

      renderLeft();
      renderRight();
    });

    btnRemove.addEventListener("click", async () => {
      if (!currentJudgeId) { alert("Please select a judge."); return; }
      if (!currentCategory) { alert("Please select a category."); return; }

      const picks = getCheckedValues("rightPick");  // selected items on the right
      if (picks.length === 0) { alert("Select one or more teams on the right."); return; }

      try {
        // Persist unassignment in DB
        const res = await fetch(`${API}/assigned-teams`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ judge_id: currentJudgeId, team_codes: picks })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

        // Rehydrate from DB so UI is authoritative
        await loadAssignmentsForJudge(currentJudgeId);
        await loadTeamsForCategory(currentCategory);
      } catch (e) {
        console.error(e);
        alert("‚ùå Failed to unassign. Check console.");
      }
    });


    // --- wiring ---
    catSel.addEventListener("change", async () => {
      const cat = catSel.value;
      if (!cat) return;
      if (currentJudgeId) await loadAssignmentsForJudge(currentJudgeId); // <-- hydrate
      await loadTeamsForCategory(cat);
    });

    judgeSel.addEventListener("change", async () => {
      currentJudgeId = judgeSel.value || "";
      if (!currentJudgeId) {
        assignedEl.innerHTML = `<div class="muted" style="padding:8px 0;">Select a judge.</div>`;
        return;
      }
      await loadAssignmentsForJudge(currentJudgeId);         // <-- hydrate from DB
      if (currentCategory) await loadTeamsForCategory(currentCategory);
      else renderRight(); // show empty/right panel baseline if no category yet
    });


    // --- init ---
    loadJudges();

    // --- Save assignments to database ---
    const btnSave = document.getElementById("btnSave");

    // --- Save assignments to database ---
    async function saveAssignments() {
      if (!currentJudgeId) { alert("Please select a judge."); return; }

      const assignedTeams = assignedByJudge[currentJudgeId] || [];
      const team_codes = assignedTeams.map(t => t.team_code);
      if (team_codes.length === 0) {
        alert("No teams assigned to this judge yet.");
        return;
      }

      try {
        const res = await fetch(`${API}/assigned-teams`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ judge_id: currentJudgeId, team_codes })
        });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

        // ‚¨áÔ∏è‚¨áÔ∏è Re-hydrate from DB so UI matches what's saved
        await loadAssignmentsForJudge(currentJudgeId);
        if (currentCategory) await loadTeamsForCategory(currentCategory);
        else renderRight();

        alert(`‚úÖ Saved ${team_codes.length} assignment(s) for ${currentJudgeId}.`);
      } catch (err) {
        console.error(err);
        alert("‚ùå Failed to save assignments. Check console for details.");
      }
    }


    btnSave.addEventListener("click", saveAssignments);

    const teamCategoryFilter = document.getElementById('teamCategoryFilter');
    const teamListBtn = document.getElementById('teamListBtn');
    const teamListStatus = document.getElementById('teamListStatus');
    const teamListContainer = document.getElementById('teamListContainer');

    // Optional: adjust to your actual API path
    const TEAMS_API = `${API}/teams`;

    teamListBtn?.addEventListener('click', loadTeams);

    async function loadTeams() {
      teamListStatus.textContent = 'Loading teams‚Ä¶';
      teamListContainer.innerHTML = '';
      try {
        const res = await fetch(TEAMS_API, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const teams = Array.isArray(data) ? data : (data.results || data.teams || []);

        allTeams = teams; // Sync global array

        renderTeamTable(teams);
        teamListStatus.textContent = `Showing ${teams.length} team(s).`;
      } catch (err) {
        console.error(err);
        teamListStatus.textContent = 'Failed to load teams. Please try again.';
      }
    }

    function renderTeamTable(rows) {
      if (!rows || rows.length === 0) {
        teamListContainer.innerHTML = '<div style="padding:12px;">No teams found.</div>';
        return;
      }

      // Decide columns to show (auto-detect common fields)
      const preferredOrder = [
        'team_code', 'password', 'team_name', 'category', 'school', 'student_names', 'assigned_judge', 'status', 'created_at'
      ];
      const allKeys = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => allKeys.add(k)));
      const columns = preferredOrder.filter(k => allKeys.has(k));
      if (columns.length === 0) columns.push(...allKeys); // fallback

      // Build controls (search)
      const controls = document.createElement('div');
      controls.style = 'display:flex; gap:8px; align-items:center; padding:8px;';
      controls.innerHTML = `
      <input id="teamSearch" placeholder="Search team code/name/school‚Ä¶" style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
      <button id="clearSearch" class="btn" style="padding:6px 10px;">Clear</button>
    `;

      // Build table
      const table = document.createElement('table');
      table.style = 'width:100%; border-collapse:collapse; font-size:14px;';
      table.innerHTML = `
      <thead>
        <tr>
          ${columns.map(c => `<th data-key="${c}" style="text-align:left; position:sticky; top:0; background:#fafafa; border-bottom:1px solid #ddd; padding:10px; cursor:pointer;">${toTitle(c)} ‚ñ≤‚ñº</th>`).join('')}
        </tr>
      </thead>
      <tbody></tbody>
    `;

      const tbody = table.querySelector('tbody');
      let currentRows = [...rows];
      let sortState = { key: columns[0], dir: 'asc' };

      function toTitle(key) {
        return key.replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase());
      }

      function drawBody(list) {
        tbody.innerHTML = list.map(r => `
        <tr>
          ${columns.map(c => `<td style="border-bottom:1px solid #eee; padding:8px 10px;">${safeCell(r[c])}</td>`).join('')}
        </tr>
      `).join('');
      }

      function safeCell(v) {
        if (v == null) return '';
        if (Array.isArray(v)) return v.join(', ');
        if (typeof v === 'object') return JSON.stringify(v);
        return String(v);
      }

      function applySort() {
        const { key, dir } = sortState;
        currentRows.sort((a, b) => {
          const av = (a[key] ?? '').toString().toLowerCase();
          const bv = (b[key] ?? '').toString().toLowerCase();
          if (av < bv) return dir === 'asc' ? -1 : 1;
          if (av > bv) return dir === 'asc' ? 1 : -1;
          return 0;
        });
        drawBody(currentRows);
      }

      function applyFilter(q) {
        const query = q.trim().toLowerCase();
        if (!query) {
          currentRows = [...rows];
        } else {
          currentRows = rows.filter(r => {
            return ['team_code', 'team_name', 'school', 'category']
              .filter(k => k in r)
              .some(k => String(r[k] ?? '').toLowerCase().includes(query));
          });
        }
        applySort();
      }

      // Sorting handlers
      table.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const k = th.dataset.key;
          if (sortState.key === k) {
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState = { key: k, dir: 'asc' };
          }
          applySort();
        });
      });

      // Search handlers
      controls.querySelector('#teamSearch').addEventListener('input', (e) => {
        applyFilter(e.target.value);
      });
      controls.querySelector('#clearSearch').addEventListener('click', () => {
        const inp = controls.querySelector('#teamSearch');
        inp.value = '';
        applyFilter('');
      });

      teamListContainer.innerHTML = '';
      teamListContainer.appendChild(controls);
      teamListContainer.appendChild(table);

      // Initial paint
      applySort();
    }

    // --- FILTER LOGIC ---
    teamCategoryFilter?.addEventListener('change', () => {
      const selected = (teamCategoryFilter.value || '').trim().toLowerCase();
      let filteredTeams;

      if (!selected) {
        filteredTeams = allTeams;
      } else {
        filteredTeams = allTeams.filter(team =>
          (team.category || '').trim().toLowerCase() === selected
        );
      }

      renderTeamTable(filteredTeams);
      teamListStatus.textContent = `Showing ${filteredTeams.length} team(s).`;
    });

    // --- VOTING STATUS LOGIC ---
    const btnVoting = document.getElementById("btnVoting");
    const panelVoting = document.getElementById("panelVoting");
    const btnRefreshVoting = document.getElementById("btnRefreshVoting");

    btnVoting?.addEventListener("click", () => {
      showPanel('panelVoting', 'btnVoting'); // Use the generic showPanel function
      fetchVotingStatus();
    });

    btnRefreshVoting?.addEventListener("click", fetchVotingStatus);

    async function fetchVotingStatus() {
      const tableBody = document.getElementById("votingTableBody");
      const countDisplay = document.getElementById("totalVotesCount");
      const rateDisplay = document.getElementById("vote participationRate");

      if (!tableBody || !countDisplay || !rateDisplay) return; // Ensure elements exist

      tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading data...</td></tr>';
      countDisplay.textContent = "...";
      rateDisplay.textContent = "...";

      try {
        // 1. Fetch Teams
        const teamsRes = await fetch(`${API}/teams`);
        const teams = await teamsRes.json();

        // 2. Fetch Votes
        // Assuming GET /votes returns a list of all vote records
        // If GET /votes is not standard, we might need to check how to get them.
        // As per user request "use the votes table", we assume endpoint exists.
        const votesRes = await fetch(`${API}/votes`);
        let votes = [];
        if (votesRes.ok) {
          votes = await votesRes.json();
        } else {
          console.warn("GET /votes failed, assuming empty or restricted");
        }

        // Create a set of team codes that have voted
        // The vote record likely has 'student_id' or 'team_code' field.
        // Based on student_dashboard, the payload key is 'student_id' which stores the team_code.
        const votedTeamCodes = new Set();
        if (Array.isArray(votes)) {
          votes.forEach(v => {
            const code = v.student_id || v.team_code; // Handle potential variations
            if (code) votedTeamCodes.add(code);
          });
        } else if (votes && typeof votes === 'object') {
          // Handle if data is wrapped { votes: [...] }
          const list = votes.votes || votes.data || [];
          list.forEach(v => {
            const code = v.student_id || v.team_code;
            if (code) votedTeamCodes.add(code);
          });
        }

        // 3. Render
        tableBody.innerHTML = "";
        let votedCount = 0;
        const teamsList = Array.isArray(teams) ? teams : [];

        // Sort teams by code
        teamsList.sort((a, b) => a.team_code.localeCompare(b.team_code));

        teamsList.forEach(team => {
          const hasVoted = votedTeamCodes.has(team.team_code);
          if (hasVoted) votedCount++;

          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${team.team_code}</td>
                    <td>${team.team_name}</td>
                    <td>${team.category}</td>
                    <td style="text-align: center;">
                        ${hasVoted ? '<span style="color:green; font-weight:bold;">‚úÖ Voted</span>' : '<span style="color:red;">‚ùå Not Voted</span>'}
                    </td>
                `;
          tableBody.appendChild(row);
        });

        // Update Summary
        countDisplay.textContent = `${votedCount} / ${teamsList.length}`;
        const rate = teamsList.length > 0 ? Math.round((votedCount / teamsList.length) * 100) : 0;
        rateDisplay.textContent = `${rate}%`;

      } catch (err) {
        console.error("Error fetching voting status:", err);
        tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Error loading data: ${err.message}</td></tr>`;
      }
    }

    // --- UTILS ---
    loadTeams();

    const exportTeamsBtn = document.getElementById('exportTeamsBtn');

    exportTeamsBtn.addEventListener('click', () => {
      if (!allTeams || allTeams.length === 0) {
        alert("No teams to export.");
        return;
      }

      const headers = [
        "Team Code",
        "Team Name",
        "Category",
        "School",
        "Members",
        "Assigned Judge",
        "Status",
        "Created At"
      ];

      const rows = allTeams.map(team => {
        return [
          `"${(team.team_code || '').replace(/"/g, '""')}"`,
          `"${(team.team_name || '').replace(/"/g, '""')}"`,
          `"${(team.category || '').replace(/"/g, '""')}"`,
          `"${(team.school || '').replace(/"/g, '""')}"`,
          `"${(team.members || '').replace(/"/g, '""')}"`,
          `"${(team.assigned_judge || '').replace(/"/g, '""')}"`,
          `"${(team.status || '').replace(/"/g, '""')}"`,
          `"${(team.created_at || '').replace(/"/g, '""')}"`
        ].join(",");
      });

      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", "teams_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });


    // Auto-generate next team code when category is selected
    document.getElementById('teamCategoryFilterAdd')?.addEventListener('change', () => {
      const cat = document.getElementById('teamCategoryFilterAdd').value;
      const nextCodeEl = document.getElementById('nt_next_code');
      if (!cat) {
        nextCodeEl.textContent = '‚Äî';
        return;
      }
      const pref = prefixForCategory(cat);
      // allTeams is the global array of all teams (maintained by fetchTeams)
      const filter = allTeams.filter(t => (t.team_code || "").startsWith(pref + "-"));
      let max = 0;
      filter.forEach(t => {
        const numPart = t.team_code.split('-')[1];
        const num = parseInt(numPart, 10);
        if (!isNaN(num) && num > max) max = num;
      });
      const nextNum = (max + 1).toString().padStart(3, '0');
      nextCodeEl.textContent = `${pref}-${nextNum}`;
    });

    // Handle Add Team
    const ntSubmit = document.getElementById('nt_submit');
    const ntStatus = document.getElementById('newTeamStatus');

    ntSubmit?.addEventListener('click', async () => {
      const nextCodeEl = document.getElementById('nt_next_code');
      const nameEl = document.getElementById('nt_team_name');
      const catEl = document.getElementById('teamCategoryFilterAdd');
      const membersEl = document.getElementById('nt_members');

      const team_code = (nextCodeEl.textContent || '').trim();
      const team_name = (nameEl.value || '').trim();
      const category = (catEl.value || '').trim();
      const student_names = (membersEl.value || '').trim();
      const password = Math.floor(10000000 + Math.random() * 90000000).toString();

      if (!team_code || team_code === '‚Äî' || !team_name || !category) {
        ntStatus.textContent = 'Please select a category and fill in team name.';
        return;
      }

      ntSubmit.disabled = true;
      ntStatus.textContent = 'Saving‚Ä¶';

      try {
        const res = await fetch(TEAMS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ team_code, team_name, category, student_names, password })
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.error) {
          const msg = data.error || `HTTP ${res.status}`;
          if (/UNIQUE constraint failed|409/.test(msg)) {
            ntStatus.textContent = 'That team code already exists.';
          } else {
            ntStatus.textContent = 'Failed to save: ' + msg;
          }
          return;
        }

        ntStatus.textContent = 'Team saved ‚úÖ';
        // Clear inputs
        nameEl.value = '';
        membersEl.value = '';
        // Trigger re-calculation of next code (simulate change or just increment manually)
        catEl.dispatchEvent(new Event('change'));

        // Refresh list if the table is visible
        if (typeof loadTeams === 'function') loadTeams();
        if (typeof fetchTeams === 'function') fetchTeams(); // Refresh Score Viewer too
      } catch (e) {
        ntStatus.textContent = 'Network error. Please try again.';
        console.error(e);
      } finally {
        ntSubmit.disabled = false;
      }
    });

    document.getElementById('logoutBtn')?.addEventListener('click', () => {
      localStorage.removeItem("isAdmin");
      window.location.href = "index.html";
    });

    // Endpoint base (mirror your teams setup)

    // Wire your existing Judges button(s).
    // If your tab button id is different, just change the selectors below.
    document.getElementById('btnJudges')?.addEventListener('click', () => {
      loadJudges();
    });
    document.getElementById('btnJudgesRefresh')?.addEventListener('click', () => {
      loadJudges();
    });

    async function loadJudges() {
      const statusEl = document.getElementById('judgeListStatus');
      const container = document.getElementById('judgeListContainer');
      if (!statusEl || !container) return;

      statusEl.textContent = 'Loading judges‚Ä¶';
      container.innerHTML = '';
      try {
        const res = await fetch(JUDGES_API, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const judges = Array.isArray(data) ? data : (data.results || data.judges || []);
        allJudges = judges;
        renderJudgesTable(judges);
        statusEl.textContent = `Showing ${judges.length} judge(s).`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = 'Failed to load judges.';
      }
    }

    // JUDGES_API and allJudges moved to top of script


    document.getElementById('btnJudgesRefresh')?.addEventListener('click', () => {
      if (typeof loadJudges === 'function') loadJudges();
    });

    const njSubmit = document.getElementById('nj_submit');
    const njStatus = document.getElementById('newJudgeStatus');

    njSubmit?.addEventListener('click', async () => {
      const judge_id = document.getElementById('nj_judge_id').value.trim().toUpperCase();
      const judge_name = document.getElementById('nj_judge_name').value.trim().toUpperCase();

      if (!judge_id || !judge_name) {
        njStatus.textContent = 'Please fill in both fields.';
        return;
      }

      njSubmit.disabled = true;
      njStatus.textContent = 'Saving‚Ä¶';

      try {
        const res = await fetch(JUDGES_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ judge_id, judge_name })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || data.error) throw new Error(data.error || `HTTP ${res.status}`);

        njStatus.textContent = 'Judge added ‚úÖ';
        document.getElementById('nj_judge_id').value = '';
        document.getElementById('nj_judge_name').value = '';

        if (typeof loadJudges === 'function') loadJudges();
      } catch (err) {
        console.error(err);
        njStatus.textContent = 'Failed to save: ' + err.message;
      } finally {
        njSubmit.disabled = false;
      }
    });

    function renderJudgesTable(rows) {
      const container = document.getElementById('judgeListContainer');
      if (!container) return;

      if (!rows || rows.length === 0) {
        container.innerHTML = '<div style="padding:12px;">No judges found.</div>';
        return;
      }

      // Common judge fields; auto-detect if some don‚Äôt exist
      const preferred = [
        'judge_id', 'judge_name', 'category', 'email', 'phone', 'assigned_count', 'created_at'
      ];
      const keys = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
      const columns = preferred.filter(k => keys.has(k));
      if (columns.length === 0) columns.push(...keys);

      // Controls
      const controls = document.createElement('div');
      controls.style = 'display:flex; gap:8px; align-items:center; padding:8px;';
      controls.innerHTML = `
    <input id="judgeSearch" placeholder="Search name/category/email‚Ä¶" style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
    <button id="clearJudgeSearch" class="tbtn" style="padding:6px 10px;">Clear</button>
  `;

      // Table
      const table = document.createElement('table');
      table.style = 'width:100%; border-collapse:collapse; font-size:14px;';
      table.innerHTML = `
    <thead>
      <tr>
        ${columns.map(c => `<th data-k="${c}" style="text-align:left; position:sticky; top:0; background:#fafafa; border-bottom:1px solid #ddd; padding:10px; cursor:pointer;">${titleCase(c)} ‚ñ≤‚ñº</th>`).join('')}
      </tr>
    </thead>
    <tbody></tbody>
  `;

      const tbody = table.querySelector('tbody');
      let current = [...rows];
      let sortState = { key: columns[0], dir: 'asc' };

      function titleCase(s) { return s.replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase()); }
      function cell(v) {
        if (v == null) return '';
        if (Array.isArray(v)) return v.join(', ');
        if (typeof v === 'object') return JSON.stringify(v);
        return String(v);
      }
      function draw(list) {
        tbody.innerHTML = list.map(r => `
      <tr>
        ${columns.map(c => `<td style="border-bottom:1px solid #eee; padding:8px 10px;">${cell(r[c])}</td>`).join('')}
      </tr>
    `).join('');
      }
      function sortNow() {
        const { key, dir } = sortState;
        current.sort((a, b) => {
          const av = (a[key] ?? '').toString().toLowerCase();
          const bv = (b[key] ?? '').toString().toLowerCase();
          if (av < bv) return dir === 'asc' ? -1 : 1;
          if (av > bv) return dir === 'asc' ? 1 : -1;
          return 0;
        });
        draw(current);
      }
      function filterNow(q) {
        const ql = q.trim().toLowerCase();
        if (!ql) {
          current = [...rows];
        } else {
          current = rows.filter(r =>
            ['judge_id', 'judge_name', 'category', 'email', 'phone']
              .filter(k => k in r)
              .some(k => String(r[k] ?? '').toLowerCase().includes(ql))
          );
        }
        sortNow();
      }

      table.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const k = th.dataset.k;
          if (sortState.key === k) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          else sortState = { key: k, dir: 'asc' };
          sortNow();
        });
      });

      controls.querySelector('#judgeSearch').addEventListener('input', e => filterNow(e.target.value));
      controls.querySelector('#clearJudgeSearch').addEventListener('click', () => {
        const inp = controls.querySelector('#judgeSearch');
        inp.value = '';
        filterNow('');
      });

      container.innerHTML = '';
      container.appendChild(controls);
      container.appendChild(table);
      sortNow();
    }

    const exportJudgesBtn = document.getElementById('exportJudgesBtn');

    exportJudgesBtn.addEventListener('click', () => {
      if (!allJudges || allJudges.length === 0) {
        alert("No judges to export.");
        return;
      }

      const headers = ["Judge ID", "Name", "Assigned Categories"];

      const rows = allJudges.map(judge => [
        `"${(judge.judge_id || '').replace(/"/g, '""')}"`,
        `"${(judge.judge_name || '').replace(/"/g, '""')}"`,
        `"${(judge.assigned_categories || []).join(';').replace(/"/g, '""')}"`
      ].join(","));

      const csvContent = [headers.join(","), ...rows].join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", "judges_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });


    /* ===============================
       Student Account Management
    ================================*/

    // STUDENTS_API moved to top of script

    // Tab switching auto-load
    let studentListLoadedOnce = false;
    document.getElementById('btnTeams')?.addEventListener('click', () => {
      if (!studentListLoadedOnce) {
        studentListLoadedOnce = true;
        loadStudents(); // This now loads teams
      }
    });

    // Refresh button
    document.getElementById('btnTeamsRefresh')?.addEventListener('click', loadStudents);

    // Uncomment this for debug.
    // Logic for ADDING A TEAM (formerly ns_submit)
    document.getElementById('nt_submit')?.addEventListener('click', async () => {
      const catEl = document.getElementById('teamCategoryFilterAdd');
      const nameEl = document.getElementById('nt_team_name');
      const membersEl = document.getElementById('nt_members');
      const statusEl = document.getElementById('newTeamStatus');

      const category = catEl.value.trim();
      const team_name = nameEl.value.trim();
      const members = membersEl.value.trim();

      // Check if all fields are filled
      if (!category || !team_name || !members) {
        statusEl.textContent = 'Please fill all fields.';
        return;
      }

      const btn = document.getElementById('nt_submit');
      btn.disabled = true;
      statusEl.textContent = 'Saving‚Ä¶';

      try {
        const response = await fetch(`${API}/teams`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ category, team_name, members })
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`Server responded with ${response.status}: ${text}`);
        }

        statusEl.textContent = 'Team saved ‚úÖ';
        nameEl.value = '';
        membersEl.value = '';
        loadStudents(); // Refresh team list
      } catch (e) {
        console.error('Network error:', e);
        statusEl.textContent = `Network error: ${e.message || 'Unknown error'}`;
      } finally {
        btn.disabled = false;
      }
    });

    async function loadStudents() {
      const statusEl = document.getElementById('studentListStatus');
      const container = document.getElementById('studentListContainer');

      if (!statusEl || !container) return;

      statusEl.textContent = 'Loading teams‚Ä¶';
      container.innerHTML = '';

      try {
        const res = await fetch(`${API}/teams`, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        const students = Array.isArray(data) ? data : (data.results || data.students || []);

        renderStudentsTable(students);
        statusEl.textContent = `Showing ${students.length} student(s).`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = '‚ùå Failed to load students.';
      }
    }

    function renderStudentsTable(rows) {
      const container = document.getElementById('studentListContainer');
      if (!container) return;

      if (!rows || rows.length === 0) {
        container.innerHTML = '<div style="padding:12px;">No students found.</div>';
        return;
      }

      const preferred = ['student_code', 'student_name', 'category', 'created_at'];
      const keys = new Set();
      rows.forEach(r => Object.keys(r).forEach(k => keys.add(k)));
      const columns = preferred.filter(k => keys.has(k));
      if (columns.length === 0) columns.push(...keys);

      // Controls
      const controls = document.createElement('div');
      controls.style = 'display:flex; gap:8px; align-items:center; padding:8px;';
      controls.innerHTML = `
    <input id="studentSearch" placeholder="Search code/name/category‚Ä¶" style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
    <button id="clearStudentSearch" class="btn" style="padding:6px 10px;">Clear</button>
  `;

      // Table
      const table = document.createElement('table');
      table.style = 'width:100%; border-collapse:collapse; font-size:14px;';
      table.innerHTML = `
    <thead>
      <tr>
        ${columns.map(c => `<th data-key="${c}" style="text-align:left; position:sticky; top:0; background:#fafafa; border-bottom:1px solid #ddd; padding:10px; cursor:pointer;">${titleCase(c)} ‚ñ≤‚ñº</th>`).join('')}
      </tr>
    </thead>
    <tbody></tbody>
  `;

      const tbody = table.querySelector('tbody');
      let currentRows = [...rows];
      let sortState = { key: columns[0], dir: 'asc' };

      function titleCase(s) { return s.replace(/_/g, ' ').replace(/\b\w/g, ch => ch.toUpperCase()); }
      function cell(v) {
        if (v == null) return '';
        if (Array.isArray(v)) return v.join(', ');
        if (typeof v === 'object') return JSON.stringify(v);
        return String(v);
      }
      function draw(list) {
        tbody.innerHTML = list.map(r => `
      <tr>
        ${columns.map(c => `<td style="border-bottom:1px solid #eee; padding:8px 10px;">${cell(r[c])}</td>`).join('')}
      </tr>
    `).join('');
      }
      function sortNow() {
        const { key, dir } = sortState;
        currentRows.sort((a, b) => {
          const av = (a[key] ?? '').toString().toLowerCase();
          const bv = (b[key] ?? '').toString().toLowerCase();
          if (av < bv) return dir === 'asc' ? -1 : 1;
          if (av > bv) return dir === 'asc' ? 1 : -1;
          return 0;
        });
        draw(currentRows);
      }
      function filterNow(q) {
        const ql = q.trim().toLowerCase();
        if (!ql) {
          currentRows = [...rows];
        } else {
          currentRows = rows.filter(r =>
            ['student_code', 'student_name', 'category']
              .filter(k => k in r)
              .some(k => String(r[k] ?? '').toLowerCase().includes(ql))
          );
        }
        sortNow();
      }

      // Event listeners
      table.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const k = th.dataset.key;
          if (sortState.key === k) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
          else sortState = { key: k, dir: 'asc' };
          sortNow();
        });
      });

      controls.querySelector('#studentSearch').addEventListener('input', (e) => filterNow(e.target.value));
      controls.querySelector('#clearStudentSearch').addEventListener('click', () => {
        controls.querySelector('#studentSearch').value = '';
        filterNow('');
      });

      container.innerHTML = '';
      container.appendChild(controls);
      container.appendChild(table);
      sortNow();
    }

    document.getElementById('nq_submit')?.addEventListener('click', (e) => {
      e.preventDefault();

      if (!confirm("Are you sure you want to submit this question?")) {
        return; // user pressed Cancel
      }

      submitQuestion(); // if OK ‚Üí run your submit function
    });

    document.getElementById('btnQuestionRefresh')?.addEventListener('click', (e) => {
      e.preventDefault();

      clearQuestionForm()
    });

    async function submitQuestion() {

      const btn = document.getElementById("nq_submit");
      const statusEl = document.getElementById("questionStatus");

      btn.disabled = true;
      statusEl.textContent = "Saving question‚Ä¶";

      const payload = {
        code: document.getElementById("nq_question_code").value,
        difficulty: document.getElementById("MarkSelect").value,
        title: document.getElementById("nq_question_title").value,
        statement: document.getElementById("nq_question_statement").value,
        testCases: Array.from({ length: 10 }, (_, i) => ({
          input: {
            raw: document.getElementById(`nq_question_input${i + 1}`).value,
            type: "input"
          },
          output: {
            raw: document.getElementById(`nq_question_out${i + 1}`).value,
            type: "output"
          }
        }))
      };

      try {
        const response = await fetch(
          "https://judging-system.yeewengloke.workers.dev/questions",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }
        );

        const text = await response.text();
        console.log("RAW RESPONSE:", text);

        if (!response.ok) {
          throw new Error(text);
        }

        const data = JSON.parse(text);
        statusEl.textContent = "Question saved successfully!";

        // After statusEl.textContent = "Question saved successfully!";
        clearQuestionForm()


      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
      } finally {
        btn.disabled = false;
      }
    }

    function clearQuestionForm() {
      document.getElementById("nq_question_code").value = '';
      document.getElementById("MarkSelect").value = '';
      document.getElementById("nq_question_title").value = '';
      document.getElementById("nq_question_statement").value = '';
      for (let i = 1; i <= 10; i++) {
        document.getElementById(`nq_question_input${i}`).value = '';
        document.getElementById(`nq_question_out${i}`).value = '';
      }
    }

  </script>
</body>

</html>