<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Dashboard</title>
  <style>
    :root {
      --brand: #17ad00;
      --btn: #ffffff;
      --btnr: #ff0000;
      --btnb: #0063e5;
      --btn-hover: #68aeff;
      --bg: #ffffff;
      --card: #fff;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: #333;
    }

    header {
      background: var(--brand);
      color: #fff;
      padding: 14px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 12px rgba(0, 0, 0, .12);
    }

    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .2px;
    }

    header .right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    main {
      max-width: 1100px;
      margin: 28px auto;
      padding: 0 20px;
    }

    /* Toolbar */
    .toolbar {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    .tbtn {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: background .2s, border-color .2s, transform .02s;
    }

    .tbtn:hover {
      background: #f8fafc;
    }

    .tbtn:active {
      transform: translateY(1px);
    }

    .tbtn.active {
      border-color: var(--btn);
      outline: 2px solid #dbeafe;
    }

    /* Panels */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px 18px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .06);
      min-height: 220px;
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    h2 {
      margin: 0 0 6px;
      color: var(--brand);
      font-size: 18px;
    }

    .muted {
      color: var(--muted);
      font-size: 14px;
    }

    /* Placeholder ‚Äúblank‚Äù states */
    .blank {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 26px;
      text-align: center;
      color: var(--muted);
      background: #fafafa;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    select,
    input,
    button {
      font-size: 15px;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .btn {
      background: var(--btn);
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: var(--btn-hover);
    }

    .btnr {
      background: var(--btnr);
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: var(--btn-hover);
    }

    .btnb {
      background: var(--btnb);
      color: #000000;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .btn:hover {
      background: var(--btn-hover);
    }

    /* Tiny helper for section toolbars */
    .sectionbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 10px 0 16px;
    }

    .spacer {
      flex: 1;
    }

    /* --- Assign grid: three columns: team | nav buttons | judge --- */
    .assign-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 20px;
    }

    /* Side-by-side dropdowns (team + judge) */
    .assign-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-top: 16px;
    }

    .assign-col {
      flex: 1;
    }

    .assign-col select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .assign-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 16px;
    }

    .assign-top .assign-col {
      flex: 1;
    }

    .assign-top .assign-col.right {
      text-align: right;
    }

    .assign-top .assign-col.right select {
      width: 60%;
    }

    @media (max-width: 768px) {
      .assign-top {
        flex-direction: column;
        align-items: stretch;
      }

      .assign-top .assign-col.right select {
        width: 100%;
      }
    }

    /* Middle column: put buttons side-by-side, centered */
    .assign-nav {
      display: flex !important;
      flex-direction: column !important;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    /* In case a global .btn makes buttons block-level */
    .assign-nav .btn,
    .assign-nav button {
      width: 120px;
      height: 42px;
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      min-width: 90px;
    }

    .blank-row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      height: 60vh;
    }

    .blank {
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    .btn-bar {
      display: flex;
      justify-content: right;
      gap: 20px;
    }

    .radio-list .radio-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 8px;
      background: #fff;
    }

    /* Make team list adapt to screen height and scroll if long */
    #teamsList {
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 6px;
      scroll-behavior: smooth;
    }

    /* Optional: hide ugly scrollbar for better aesthetics (for WebKit browsers) */
    #teamsList::-webkit-scrollbar {
      width: 6px;
    }

    #teamsList::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 6px;
    }

    #teamsList::-webkit-scrollbar-thumb:hover {
      background-color: #94a3b8;
    }

    .radio-list .team-code {
      font-weight: 600;
      min-width: 80px;
      color: #1f2937;
    }

    .radio-list .team-name {
      color: #374151;
    }

    .radio-list input[type=checkbox] {
      transform: scale(1.1);
    }

    .assign-top {
      display: flex;
      gap: 20px;
      align-items: flex-end;
      margin-bottom: 16px;
    }

    .assign-top .assign-col {
      flex: 1;
    }

    .assign-boards {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      /* left | middle | right */
      gap: 20px;
      align-items: stretch;
    }

    .list {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      padding: 10px;
      display: flex;
      flex-direction: column;
      min-height: 260px;
    }

    .list-title {
      font-weight: 700;
      color: #334155;
      margin: 4px 6px 8px;
    }

    .scroll {
      overflow-y: auto;
      max-height: 50vh;
      padding-right: 6px;
    }

    .scroll::-webkit-scrollbar {
      width: 6px;
    }

    .scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 6px;
    }

    .scroll::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .assign-nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
      justify-content: center;
      align-items: center;
    }

    .assign-nav button {
      width: 120px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .radio-list .radio-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .radio-list .team-code {
      font-weight: 600;
      min-width: 80px;
      color: #1f2937;
    }

    .radio-list input[type=checkbox] {
      transform: scale(1.1);
    }

    @media (max-width:820px) {
      .assign-top {
        flex-direction: column;
        align-items: stretch;
      }

      .assign-boards {
        grid-template-columns: 1fr;
      }

      .assign-nav {
        flex-direction: row;
      }
    }

    /* START MICKY */

    /* Score Viewer Tab */
    .team-card {
      border: 1px solid #ddd;
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .team-card h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .btn {
      margin-top: 8px;
      padding: 6px 12px;
      background: #128909;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn:hover {
      background: #2980b9;
    }

    .empty,
    .error {
      color: #e74c3c;
      font-style: italic;
    }

    .teams-table select {
      width: 100%;
      padding: 4px;
      border: 1px solid #cbd5e1;
      border-radius: 4px;
      font-size: 13px;
      background: white;
    }

    .teams-table select:hover {
      border-color: #94a8ff;
    }

    /* END MICKY */

    .countdown-container {
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .countdown-title {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .countdown-timer {
      font-size: 32px;
      font-weight: 700;
      color: var(--brand);
      font-family: monospace;
    }

    #hackathonView,
    #innoView {
      display: none;
    }
  </style>
</head>

<body>
  <header>
    <h1>Team Dashboard</h1>
    <div class="right">
      <button onclick="logout()">Logout</button>
    </div>
  </header>
  <main>
    <!-- Top toolbar
    <div class="toolbar" role="tablist" aria-label="Admin actions">
      <button id="btnAssign" class="tbtn" role="tab" aria-controls="panelAssign" aria-selected="false">Assign Teams</button>
      <button id="btnViewer" class="tbtn" role="tab" aria-controls="panelViewer" aria-selected="false">Score Viewer</button>
      <button id="btnTeams"  class="tbtn" role="tab" aria-controls="panelTeams"  aria-selected="false">Team List</button>
      <button id="btnJudges" class="tbtn" role="tab" aria-controls="panelJudges" aria-selected="false">Judges List</button>
      <button id="btnStudents" class="tbtn" role="tab" aria-controls="panelStudents" aria-selected="false">Create Student Account</button>
    </div> -->

    <!-- Boards: Available | Buttons | Assigned (under judge) -->
    <!-- <div class="assign-nav"> -->
    <!-- LEFT: Available teams (checkbox, multi-select) -->
    <!-- Top row: Team Categories (left) + Judge Names (right) -->
    <div class="assign-top">
      <div class="assign-col">
        <div id="innoView">
          <h1>Team Voting!</h1>
          <div class="spacer"></div>
          <div class="assign-boards">
            <div id="voteContainer"></div>
          </div>
          <button class="tbtn" id="voteSubmit">‚ûï Submit</button>
          <p id="voteStatus"></p>
        </div>

        <div id="hackathonView">
          <div class="countdown-container">
            <div class="countdown-title">Hackathon Starts In</div>
            <div id="countdown" class="countdown-timer">00:00:00:00</div>
          </div>
          <button class="tbtn" id="Battle" style="width: 100%; padding: 20px; font-size: 20px;">‚öîÔ∏è Battle (Start
            Hackathon)</button>

          <div style="margin-top: 20px; text-align: center;">
            <p style="font-weight: 600; margin-bottom: 8px;">Press the File Submission button when you finished
              attempting every question you can.</p>
            <button class="tbtn" id="btnFileSubmission"
              style="width: 100%; padding: 20px; font-size: 20px; background-color: #f59e0b; color: white;">File
              Submission (For Block-Based)</button>
          </div>
        </div>

      </div>

      <script>

        // ----- CONFIG -----
        const API = "https://judging-system.yeewengloke.workers.dev"; // your D1 API
        const categories = ["Inno-Tech Primary", "Inno-Tech Secondary", "Inno-Maker Primary", "Inno-Maker Secondary",
          "Tech-Hackathon Tier 2 Block-Based", "Tech-Hackathon Tier 2 Text-Based"]; // all categories

        // Keep track of loaded teams and user selections
        const teamsByCategory = {};
        const userVotes = {}; // { "Category A": "TEAM001", ... }

        // localStorage.setItem("student_id", data.user.student_id);      // from worker
        // localStorage.setItem("student_name", data.user.student_name);  // from worker


        // ----- HELPER -----
        function prefixForCategory(category) {
          if (category === "Inno-Tech Primary") return "ITP";
          if (category === "Inno-Tech Secondary") return "ITS";
          if (category === "Inno-Maker Primary") return "IMP";
          if (category === "Inno-Maker Secondary") return "IMS";
          if (category === "Tech-Hackathon Tier 2 Block-Based") return "TH2B";
          if (category === "Tech-Hackathon Tier 2 Text-Based") return "TH2T";

          return category[category.length - 1];
        }




        async function loadTeamsForCategory(category) {

          const prefix = prefixForCategory(category);

          if (!teamsByCategory[category]) {
            const url = new URL(`${API}/teams`);
            url.searchParams.set("category", prefix); // FIXED
            const res = await fetch(url);
            const data = await res.json();

            // Filter by prefix (optional)
            teamsByCategory[category] = data.filter(t =>
              (t.team_code || "").startsWith(prefix)
            );
          }

          renderCategoryDropdown(category);
        }


        // ----- DROPDOWNS -----
        function renderCategoryDropdown(category) {
          const container = document.getElementById("voteContainer");
          if (!container) return;

          // Create wrapper for each category
          let wrapper = document.getElementById(`wrapper-${category}`);
          if (!wrapper) {
            wrapper = document.createElement("div");
            wrapper.id = `wrapper-${category}`;
            wrapper.style.marginBottom = "1rem";
            container.appendChild(wrapper);
          } else {
            wrapper.innerHTML = ""; // clear previous
          }

          const label = document.createElement("label");
          label.textContent = `Vote for best team in ${category}:`;
          label.htmlFor = `select-${category}`;
          wrapper.appendChild(label);

          const select = document.createElement("select");
          select.id = `select-${category}`;
          select.style.marginLeft = "0.5rem";

          // Add options
          teamsByCategory[category].forEach(team => {
            const option = document.createElement("option");
            option.value = team.team_code;
            option.textContent = team.team_name;
            select.appendChild(option);
          });

          // Capture selection
          select.addEventListener("change", () => {
            userVotes[category] = select.value;
          });

          // Initialize with first team if exists
          if (teamsByCategory[category].length > 0) {
            userVotes[category] = teamsByCategory[category][0].team_code;
          }

          wrapper.appendChild(select);
        }

        // (Removed immediate initialization)

        // ----- SUBMIT VOTES -----
        document.getElementById("voteSubmit").addEventListener("click", async () => {
          const statusEl = document.getElementById("voteStatus");
          statusEl.textContent = "Submitting votes‚Ä¶";

          try {
            const team_code = localStorage.getItem("team_code");
            console.log(team_code);

            const response = await fetch(`${API}/votes`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                student_id: team_code,          // ‚úÖ using team_code as ID
                votes: userVotes     // ‚úÖ required by backend
              })
            });

            const text = await response.text();
            if (!response.ok) throw new Error(text);

            const data = JSON.parse(text);
            statusEl.textContent = "Votes submitted successfully ‚úÖ";

            // Mark as voted locally
            localStorage.setItem(`hasVoted_${team_code}`, "true");

            // Update UI to reflect voted state immediately
            setTimeout(() => {
              const voteContainer = document.getElementById("voteContainer");
              voteContainer.innerHTML = "<div class='blank'><h3>‚úÖ You have already voted!</h3><p>Thank you for participating.</p></div>";
              document.getElementById("voteSubmit").style.display = "none";
              statusEl.textContent = "";
            }, 1500);

          } catch (err) {
            console.error(err);
            statusEl.textContent = "Error submitting votes: " + err.message;
          }

        });

        document.addEventListener("DOMContentLoaded", async () => {
          const team_code = localStorage.getItem("team_code");

          if (!team_code) {
            window.location.href = "index.html";
            return;
          }

          // Determine View
          const hackathonPrefixes = ["THP", "THS"];
          const isHackathon = hackathonPrefixes.some(p => team_code.startsWith(p));

          if (isHackathon) {
            document.getElementById("hackathonView").style.display = "block";

            // Only show File Submission for THP (Primary) as they might be Block-Based
            if (!team_code.startsWith("THP")) {
              const fsBtn = document.getElementById("btnFileSubmission");
              if (fsBtn) fsBtn.parentElement.style.display = "none";
            }

            startCountdown();
          } else {
            document.getElementById("innoView").style.display = "block";

            // Check if already voted
            const hasVoted = localStorage.getItem(`hasVoted_${team_code}`);
            if (hasVoted === "true") {
              const voteContainer = document.getElementById("voteContainer");
              voteContainer.innerHTML = "<div class='blank'><h3>‚úÖ You have already voted!</h3><p>Thank you for participating.</p></div>";
              const submitBtn = document.getElementById("voteSubmit");
              if (submitBtn) submitBtn.style.display = "none";
            } else {
              // Filter out Hackathon voting for IM and IT students
              let catsToDisplay = categories;
              if (team_code.startsWith("IM") || team_code.startsWith("IT")) {
                catsToDisplay = categories.filter(c => !c.includes("Tech-Hackathon"));
              }
              catsToDisplay.forEach(cat => loadTeamsForCategory(cat));
            }
          }

          try {
            const res = await fetch(`${API}/start-session`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ student_id: team_code })
            });

            const data = await res.json();

            if (!data.success) {
              alert(data.message || "Session already completed.");
              localStorage.setItem("sessionEnded", "true");
              const battleBtn = document.getElementById("Battle");
              if (battleBtn) {
                battleBtn.disabled = true;
                battleBtn.textContent = "‚úÖ Session Completed";
                battleBtn.style.opacity = "0.6";
                battleBtn.style.cursor = "not-allowed";
              }
            } else {
              localStorage.setItem("sessionEnded", "false");
            }

          } catch (err) {
            console.error(err);
            alert("Unable to verify session. Please try again.");
            window.location.href = "index.html";
          }
        });

        function startCountdown() {
          const target = new Date("2026-01-08T10:00:00+08:00").getTime();
          const timerEl = document.getElementById("countdown");

          function update() {
            const now = new Date().getTime();
            const diff = target - now;

            if (diff <= 0) {
              timerEl.textContent = "00:00:00:00";
              return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);

            timerEl.textContent =
              `${String(days).padStart(2, '0')}:${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
          }

          update();
          setInterval(update, 1000);
        }

        document.getElementById("Battle").addEventListener("click", () => {
          if (localStorage.getItem("sessionEnded") === "true") {
            alert("You have already completed your session. You cannot start again.");
            window.location.href = "student_dashboard.html";
            return;
          }

          const team_code = localStorage.getItem("team_code");

          if (team_code.startsWith("THP")) {
            // Choice for Primary
            const userChoice = confirm("Press OK for Block-Based üß±, or Cancel for Text-Based üíª");
            const targetPage = userChoice ? "blockbased.html" : "textbased.html";
            window.location.href = targetPage;
          } else {
            // Secondary -> Text-Based 
            window.location.href = "textbased.html";
          }
        });

        document.getElementById("btnFileSubmission").addEventListener("click", () => {
          const confirmed = confirm("Are you finished attempting each question? If not, finish them first and submit them all at once.");
          if (confirmed) {
            window.open("https://forms.gle/your-google-form-url", "_blank"); // Placeholder URL as requested
          }
        });



        // ===== LOGOUT =====
        function logout() {
          localStorage.removeItem("team_code");
          window.location.href = "index.html";
        }

        // // ===== START =====
        // init()

      </script>

</html>